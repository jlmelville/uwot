<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Embedding New Data • uwot</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Embedding New Data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">uwot</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.2.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/uwot.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jlmelville/uwot/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Embedding New Data</h1>
            <h3 data-toc-skip class="subtitle">Out of Sample Data</h3>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jlmelville/uwot/blob/master/vignettes/articles/embedding-new-data.Rmd" class="external-link"><code>vignettes/articles/embedding-new-data.Rmd</code></a></small>
      <div class="d-none name"><code>embedding-new-data.Rmd</code></div>
    </div>

    
    
<p>Note: some of this information is repeated from the <a href="https://jlmelville.github.io/uwot/articles/metric-learning.html">metric
learning article</a>, an article so poorly-titled that I was unable to
find where I had discussed transforming new data. <a href="https://github.com/jlmelville/uwot/issues/132" class="external-link">As requested</a> by
<a href="https://github.com/RoyiAvital" class="external-link">RoyiAvital</a>, this article
focuses only on tranforming new data into an existing embedding, and a
description of how this is achieved.</p>
<p>To embed new data into an embedding so you should:</p>
<ul>
<li>set <code>ret_model = TRUE</code> when running <code>umap</code> on
the original data.</li>
<li>Provide the return value of that call to <code>umap</code> to the
<code>umap_transform</code> function along with your new data.</li>
</ul>
<div class="section level2">
<h2 id="how-it-works">How It Works<a class="anchor" aria-label="anchor" href="#how-it-works"></a>
</h2>
<ol style="list-style-type: decimal">
<li>Let’s say
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>P</mi><annotation encoding="application/x-tex">P</annotation></semantics></math>
are the set of embedded points and there are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>N</mi><mi>P</mi></msub><annotation encoding="application/x-tex">N_P</annotation></semantics></math>
of them. Likewise there are new points to embed called
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>
(could be as few as 1 point in Q).</li>
<li>For a given new item to embed,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>q</mi><annotation encoding="application/x-tex">q</annotation></semantics></math>,
find the <code>n_neighbors</code> nearest neighbors from the already
embedded dataset (i.e. find
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mn>1</mn></msub><annotation encoding="application/x-tex">p_1</annotation></semantics></math>`,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mn>2</mn></msub><annotation encoding="application/x-tex">p_2</annotation></semantics></math>,
…,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>k</mi></msub><annotation encoding="application/x-tex">p_k</annotation></semantics></math>).</li>
<li>Form the affinity matrix between the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>N</mi><mi>Q</mi></msub><annotation encoding="application/x-tex">N_Q</annotation></semantics></math>
points to embed and the original
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>N</mi><mi>P</mi></msub><annotation encoding="application/x-tex">N_P</annotation></semantics></math>
points. The affinity matrix is no longer square or symmetric but that
doesn’t matter.</li>
<li>Embed that as usual, where we want the Euclidean distance in the
low-dimensional space to reproduce the affinities in the affinity
matrix, via the usual UMAP cost function. Each pair of items is of the
form
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>p</mi><mo>,</mo><mi>q</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(p, q)</annotation></semantics></math>,
i.e. it’s always one point from the original data and one from the new
data. You don’t have pairs like
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>p</mi><mo>,</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(p, p)</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>q</mi><mo>,</mo><mi>q</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(q, q)</annotation></semantics></math>.</li>
<li>The only deviation from the standard way of doing things is that you
don’t let the coordinates of any of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>
points update only the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>q</mi><annotation encoding="application/x-tex">q</annotation></semantics></math>.</li>
</ol>
<p>There are some minor differences to the parameters involved in the
transform:</p>
<ol style="list-style-type: decimal">
<li>Coordinates are initialized by taking the weighted average of the
neighbors coordinates, where the weights are the affinities.</li>
<li>In terms of calculating those affinities, the local connectivity is
adjusted down by one. This is a rather obscure parameter that I rarely
see (never?) being adjusted by users in either <code>uwot</code> or in
other implementations. It controls the number of neighbors that are
considered fully connected to a point (i.e. gets an affinity of 1.0).
It’s usually set to one, so that means when transforming data, the local
connectivity is set to 0. I suspect the reason for this is that because
of the initialization: because the points are located close to its
neighbors we don’t need to worry about having items which are very
distant during the optimization so we don’t need to enforce closeness to
a given point.</li>
<li>The learning rate is set to a quarter of whatever it was during
training.</li>
</ol>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>Let’s use the <code>fashion</code> MNIST dataset.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"jlmelville/snedata"</span><span class="op">)</span></span>
<span><span class="va">fashion</span> <span class="op">&lt;-</span> <span class="fu">snedata</span><span class="fu">::</span><span class="fu">download_fashion_mnist</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The Fashion MNIST dataset contains 70,000 images of fashion items, in
one of ten classes. A factor column, <code>Label</code> contains the id
of each item (from <code>0</code> to <code>9</code>) for backwards
compatibility with the MNIST dataset, which Fashion MNIST is designed to
be a drop-in replacement for. A more descriptive, but entirely
equivalent, factor column, <code>Description</code> provides a short
text string to describe the classes, e.g. the <code>Description</code>
<code>"Coat"</code> and the <code>Label</code> <code>4</code> are
equivalent.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fashion</span>, <span class="fl">60000</span><span class="op">)</span></span>
<span><span class="va">fashion_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">fashion</span>, <span class="fl">10000</span><span class="op">)</span></span></code></pre></div>
<p>Training proceeds by running UMAP normally, but we need to return
more than just the embedded coordinates. To return enough information to
embed new data, we need to set the <code>ret_model</code> flag when we
run <code>umap</code>. This will return a list. The embedded coordinates
can be found as the <code>embedding</code> item.</p>
<div class="section level4">
<h4 id="training-data">Training Data<a class="anchor" aria-label="anchor" href="#training-data"></a>
</h4>
<p>I am using the <code>umap2</code> function here, but you can use
<code>umap</code> or <code>tumap</code> as you wish. I am also making
use of the <code>rnndescent</code> library for nearest neighbor search.
This is also optional (just don’t set <code>nn_method</code>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1337</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jlmelville.github.io/rnndescent/" class="external-link">rnndescent</a></span><span class="op">)</span></span>
<span><span class="va">fashion_umap_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap2.html">umap2</a></span><span class="op">(</span><span class="va">fashion_train</span>, ret_model <span class="op">=</span> <span class="cn">TRUE</span>, nn_method <span class="op">=</span> <span class="st">"nndescent"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="test-data">Test Data<a class="anchor" aria-label="anchor" href="#test-data"></a>
</h4>
<p>To embed new data, use the <code>umap_transform</code> function. Pass
the new data and the trained UMAP model. There’s no difference between
using a standard UMAP model:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_umap_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap_transform.html">umap_transform</a></span><span class="op">(</span><span class="va">fashion_test</span>, <span class="va">fashion_umap_train</span><span class="op">)</span></span></code></pre></div>
<p>Here are the results:</p>
<table class="table">
<colgroup>
<col width="52%">
<col width="47%">
</colgroup>
<thead><tr class="header">
<th align="center">Training data (60,000 points)</th>
<th align="center">Test data (10,000 points)</th>
</tr></thead>
<tbody><tr class="odd">
<td align="center"><img src="img%2Fembedding-new-data%2Ffashion-train.png" alt="Fashion UMAP Train"></td>
<td align="center"><img src="img%2Fembedding-new-data%2Ffashion-test.png" alt="Fashion UMAP Test"></td>
</tr></tbody>
</table>
<p>Looks pretty decent, although you could argue it’s not truly an “out
of sample” example because the test data is all from the same
distribution as the training data. If you made the test data an entire
set of one labels, it is obviously not going to embed in the same place
as it appear in the full embedding. You are also going to miss the
interactions between the points within the test data.</p>
<p>Also, be aware that with small datasets you can get some odd looking
ring effects from embedding the test data. See this issue for more
details: <a href="https://github.com/jlmelville/uwot/issues/128" class="external-link uri">https://github.com/jlmelville/uwot/issues/128</a> – in that
issue I speculate that it’s due to false negatives being included in the
negative sampling, i.e. actual close neighbors that should only be used
for attractive forces.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James Melville.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Fast SGD settings • uwot</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Fast SGD settings">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">uwot</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.3.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/uwot.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jlmelville/uwot/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Fast SGD settings</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jlmelville/uwot/blob/master/vignettes/articles/fast-sgd.Rmd" class="external-link"><code>vignettes/articles/fast-sgd.Rmd</code></a></small>
      <div class="d-none name"><code>fast-sgd.Rmd</code></div>
    </div>

    
    
<p>By default, <code>uwot</code> uses some conservative settings during
the stochastic gradient descent. But there are some options that can
speed things up:</p>
<ul>
<li>
<code>n_sgd_threads = "auto"</code> (or any value greater than one):
this is the biggest thing you can do to speed up optimization. The
optimization is now spread across multiple threads. The
<code>"auto"</code> setting sets the value to that used in the other
multi-threaded part of the code, which is controlled by
<code>n_threads</code>. The downside to using multiple threads is that
you can no longer guarantee the reproducibility of the results.
Normally, you would expect the same results if you called
<code>set.seed</code> before each run. This will not be the case if set
<code>n_sgd_threads</code>.</li>
<li>
<code>pcg_rand = FALSE</code>: the default random number generator
used in the optimization is taken from <a href="http://www.pcg-random.org/" class="external-link">the PCG family</a>. This is quite fast
and has good statistical properties. An alternative PRNG is an
implementation of the Tausworthe “taus88” generator, which is used in
the Python implementation of UMAP and which I have translated from
Python into C++. By setting <code>pcg_rand = FALSE</code>, you will get
the taus88 generator. This is faster than PCG, but bear in mind that PCG
was designed by computer science professor <a href="https://www.cs.hmc.edu/~oneill/index.html" class="external-link">Melissa O’Neill</a>,
and the taus88 implementation was translated into C++ by me (I am not a
computer science professor), so if you have any concerns about the
possibility of artifacts from bad random number generation, stick with
PCG. Nonetheless, it probably gives results similar to that in the
Python UMAP implementation most of the time.</li>
<li>
<code>approx_pow = TRUE</code>: the UMAP gradient requires some
power calculations, which are quite slow compared to other arithmetic
operations. An <a href="https://martin.ankerl.com/2012/01/25/optimized-approximative-pow-in-c-and-cpp/" class="external-link">approximation
to pow by Martin Ankerl</a> can give a noticeable speed up.</li>
<li>
<code>fast_sgd = TRUE</code>: this just sets all three of the above
options at once, to make life a bit easier.</li>
</ul>
<p>If you need reproducibility (e.g. for scientific/publication
purposes), then using multiple optimization threads is a deal-breaker.
But for visualization purposes or if reproducibility isn’t that
important to you, then these settings can give a meaningful speed up of
the performance of <code>uwot</code>, without hurting the quality of the
layout.</p>
<p>To prove it, here are some images of embeddings with the fast
settings on and off. On the left are images with the optimization
settings left in their default (slower) values. I also use PCA to reduce
the dimensionality to 100:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1337</span><span class="op">)</span></span>
<span><span class="va">mnist_umap_slow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span><span class="va">mnist</span>, pca <span class="op">=</span> <span class="fl">100</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>On the right are the embeddings from using
<code>fast_sgd = TRUE</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1337</span><span class="op">)</span></span>
<span><span class="va">mnist_umap_fast</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span><span class="va">mnist</span>, pca <span class="op">=</span> <span class="fl">100</span>, fast_sgd <span class="op">=</span> <span class="cn">TRUE</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Six threads were used in the stochastic gradient descent.</p>
<p>For details on the datasets, see the <a href="https://jlmelville.github.io/uwot/articles/umap-examples.html">examples</a>
page. The timings are given in the title, in minutes and seconds. Note
that this is for entire run, not just the optimization phase, i.e. it
includes the PCA dimensionality reduction and nearest neighbor search,
which is usually the slowest part of the run and which is not affected
by <code>fast_sgd</code>.</p>
<div class="section level3">
<h3 id="mnist">mnist<a class="anchor" aria-label="anchor" href="#mnist"></a>
</h3>
<table class="table">
<colgroup>
<col width="51%">
<col width="48%">
</colgroup>
<tbody><tr class="odd">
<td align="center"><img src="img%2Ffast-sgd%2Fmnist_slow.png" alt="mnist slow"></td>
<td align="center"><img src="img%2Ffast-sgd%2Fmnist_fast.png" alt="mnist fast"></td>
</tr></tbody>
</table>
</div>
<div class="section level3">
<h3 id="fashion">fashion<a class="anchor" aria-label="anchor" href="#fashion"></a>
</h3>
<table class="table">
<colgroup>
<col width="51%">
<col width="48%">
</colgroup>
<tbody><tr class="odd">
<td align="center"><img src="img%2Ffast-sgd%2Ffashion_slow.png" alt="fashion slow"></td>
<td align="center"><img src="img%2Ffast-sgd%2Ffashion_fast.png" alt="fashion fast"></td>
</tr></tbody>
</table>
</div>
<div class="section level3">
<h3 id="kuzushiji">kuzushiji<a class="anchor" aria-label="anchor" href="#kuzushiji"></a>
</h3>
<table class="table">
<colgroup>
<col width="51%">
<col width="48%">
</colgroup>
<tbody><tr class="odd">
<td align="center"><img src="img%2Ffast-sgd%2Fkuzushiji_slow.png" alt="kuzushiji slow"></td>
<td align="center"><img src="img%2Ffast-sgd%2Fkuzushiji_fast.png" alt="kuzushiji fast"></td>
</tr></tbody>
</table>
</div>
<div class="section level3">
<h3 id="norb">norb<a class="anchor" aria-label="anchor" href="#norb"></a>
</h3>
<table class="table">
<colgroup>
<col width="51%">
<col width="48%">
</colgroup>
<tbody><tr class="odd">
<td align="center"><img src="img%2Ffast-sgd%2Fnorb_slow.png" alt="norb slow"></td>
<td align="center"><img src="img%2Ffast-sgd%2Fnorb_fast.png" alt="norb fast"></td>
</tr></tbody>
</table>
<p>The distribution of clusters here does a look a little bit different,
but I think it’s within the variation that one would expect from the
stochastic nature of the optimization. To bolster my point, here are two
further runs of UMAP on the NORB dataset with
<code>fast_sgd = FALSE</code> and different seeds:</p>
<table class="table">
<colgroup>
<col width="51%">
<col width="48%">
</colgroup>
<tbody><tr class="odd">
<td align="center"><img src="img%2Ffast-sgd%2Fnorb_42.png" alt="norb 42"></td>
<td align="center"><img src="img%2Ffast-sgd%2Fnorb_5446.png" alt="norb 5446"></td>
</tr></tbody>
</table>
<p>I think if you didn’t know one of these four images was generated
with the fast settiings, you’d be hard pressed to pick it out of the
line up. The variation between images is more likely due to the default
<code>n_neighbors</code> being too low to capture the global structure.
Here’s some plots with <code>n_neighbors = 150</code>, and
<code>n_epochs = 500</code> to account for the increased number of edges
that need sampling:</p>
<table class="table">
<colgroup>
<col width="51%">
<col width="48%">
</colgroup>
<tbody><tr class="odd">
<td align="center"><img src="img%2Ffast-sgd%2Fnorb150_slow.png" alt="norb 150 slow"></td>
<td align="center"><img src="img%2Ffast-sgd%2Fnorb150_fast.png" alt="norb 150 fast"></td>
</tr></tbody>
</table>
<p>Apart from one of the blue loops being open in the
<code>fast_sgd = TRUE</code> result, which is probably fixable with a
longer optimization, the global arrangement of the two plots is pretty
similar.</p>
</div>
<div class="section level3">
<h3 id="tasic2018">tasic2018<a class="anchor" aria-label="anchor" href="#tasic2018"></a>
</h3>
<table class="table">
<colgroup>
<col width="51%">
<col width="48%">
</colgroup>
<tbody><tr class="odd">
<td align="center"><img src="img%2Ffast-sgd%2Ftasic2018_slow.png" alt="tasic2018 slow"></td>
<td align="center"><img src="img%2Ffast-sgd%2Ftasic2018_fast.png" alt="tasic2018 fast"></td>
</tr></tbody>
</table>
</div>
<div class="section level3">
<h3 id="macosko2015">macosko2015<a class="anchor" aria-label="anchor" href="#macosko2015"></a>
</h3>
<table class="table">
<colgroup>
<col width="51%">
<col width="48%">
</colgroup>
<tbody><tr class="odd">
<td align="center"><img src="img%2Ffast-sgd%2Fmacosko2015_slow.png" alt="macosko2015 slow"></td>
<td align="center"><img src="img%2Ffast-sgd%2Fmacosko2015_fast.png" alt="macosko2015 fast"></td>
</tr></tbody>
</table>
</div>
<div class="section level2">
<h2 id="recommendations">Recommendations<a class="anchor" aria-label="anchor" href="#recommendations"></a>
</h2>
<p>From these results, I’d say that the <code>fast_sgd = TRUE</code>
settings give results which are effectively indistinguishable from the
slower settings, so if you want to save a bit of time, there seems no
harm in using them. The actual time savings you’ll see depend on how
long the nearest neighbor search takes, and any initial PCA you carry
out on the input (as we do in all these examples) can take a fair amount
of the run time. For example on NORB, the PCA takes up 5 minutes of the
six-and-a-half minute total run time, so there’s not a lot of time to be
saved. But for MNIST and Fashion, you can effectively halve the run time
(with six threads, anyway).</p>
<p>If reproducibility is important to you, then using multiple threads
in the optimization is out of the question, although that’s what gives
the biggest speed increase. However, you could still consider setting
<code>approx_pow = TRUE, pcg_rand = FALSE</code>. For MNIST-sized
datasets (<code>mnist</code>, <code>fashion</code>,
<code>kuzushiji</code>) I saw a reasonable speed up of around 25%. For
datasets where the PCA and nearest neighbor search dominates, the gains
are smaller: a 10-15% speedup for <code>tasic2018</code> and
<code>macosko2015</code>, and only 5% for <code>norb</code>. If you need
to set <code>n_epochs</code> higher, then these time savings will
increase.</p>
<div class="section level3">
<h3 id="update-december-22-2024">Update December 22 2024<a class="anchor" aria-label="anchor" href="#update-december-22-2024"></a>
</h3>
<p>Since I wrote this document, there are some extra options available.
As of uwot 0.2.3, the <code>rng_type</code> parameter is preferred over
<code>pcg_rand</code>. The equivalent of <code>pcg_rand = FALSE</code>
is <code>rng_type = "tausworthe"</code>, but you can also set
<code>rng_type = "deterministic"</code>, which will deterministically
sample the vertices. This can give a bigger speed up than
<code>rng_type = "tausworthe"</code>.</p>
<p>Further, if you are using the <code>umap2</code> function and have <a href="https://cran.r-project.org/package=rnndescent" class="external-link">rnndescent</a>
installed, the following parameters can be used to speed up the nearest
neighbor search:
<code>nn_method = "nndescent", nn_args = list(n_trees = 8, max_candidates = 20)</code>.</p>
<p>Finally, you can also consider setting
<code>negative_sample_rate = 4</code>, which will give a slight speed up
versus the default sample rate of 5.</p>
<p>These suggestions are based on a comment by <a href="https://www.reddit.com/r/MachineLearning/comments/1gsjfq9/comment/lxip9wy/" class="external-link">Leland
McInnes on Reddit</a>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James Melville.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="uwot">
<title>Working with Sparse Data • uwot</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Working with Sparse Data">
<meta property="og:description" content="uwot">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">uwot</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.16.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/uwot.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/jlmelville/uwot/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Working with Sparse Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jlmelville/uwot/blob/HEAD/vignettes/articles/sparse-data-example.Rmd" class="external-link"><code>vignettes/articles/sparse-data-example.Rmd</code></a></small>
      <div class="d-none name"><code>sparse-data-example.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="text-analysis-of-the-20-newsgroups-dataset">Text Analysis of the 20 Newsgroups Dataset<a class="anchor" aria-label="anchor" href="#text-analysis-of-the-20-newsgroups-dataset"></a>
</h2>
<p>A great use case for working with sparse data is TF-IDF text
analysis. Despite the prevalence of deep-learning-based text embedding,
TF-IDF is simple, far less compute intensive and can be surprisingly
effective. Most dimensionality reduction methods don’t work well with
sparse data, and need the input data to be dense. <code>uwot</code> is
no different, but one of the Python UMAP’s unique features is that it
can work with sparse data, due to its use of <a href="https://github.com/lmcinnes/pynndescent" class="external-link">PyNNDescent</a> for
nearest neighbor search.</p>
<p>There is a <a href="https://umap-learn.readthedocs.io/en/latest/sparse.html" class="external-link">Python
UMAP with sparse data</a> tutorial that uses the <a href="http://qwone.com/~jason/20Newsgroups/" class="external-link">20 Newsgroups</a> dataset
that I have long wanted to replicate in R. The main barriers have been
the lack of a straight-forward way to download the data and the lack of
a fast approximate nearest neighbor search package that can work with
sparse data.</p>
<p>The first problem is solved with the <a href="https://github.com/jlmelville/snedata" class="external-link">snedata</a> package, to
which I recently added a <code>download_twenty_newsgroups</code>
function. That took up a large chunk of one afternoon and evening. The
second problem is solved by replicating the PyNNDescent package in R.
This took me a bit longer, but a mere 4 years later, the <a href="https://cran.r-project.org/package=rnndescent" class="external-link">rnndescent</a>
package is finally in a usable state. Consequently, the
<code>uwot</code> package can now make use of <code>rnndescent</code>
and support sparse input via the <code>umap2</code> function.</p>
<p>So let’s get started. Apart from the Python example above, some other
good resources for doing text analysis on this dataset can be found in
chapter 9 of <a href="https://www.tidytextmining.com/usenet#usenet" class="external-link">text
mining with R</a> and the juicily-titled Python notebook <a href="https://github.com/Alvant/20-newsgroups-secrets" class="external-link">20 Newsgroups
Secrets</a>.</p>
</div>
<div class="section level2">
<h2 id="downloading-the-20-newsgroups-dataset">Downloading the 20 Newsgroups Dataset<a class="anchor" aria-label="anchor" href="#downloading-the-20-newsgroups-dataset"></a>
</h2>
<p>The <a href="http://qwone.com/~jason/20Newsgroups/" class="external-link">20 Newsgroups</a>
dataset is (nearly) 20,000 usenet posts sampled (nearly) equally from 20
different newsgroups. The webpage linked above contains more information
on the data’s provenance and structure. We can use
<code>snedata::download_twenty_newsgroups</code> to download it:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"jlmelville/snedata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ng20</span> <span class="op">&lt;-</span> <span class="fu">snedata</span><span class="fu">::</span><span class="fu">download_twenty_newsgroups</span><span class="op">(</span>subset <span class="op">=</span> <span class="st">"all"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The <code>subset</code> argument can be used to download only the
training or test set data but I will use all of it. The
<code>verbose</code> argument is useful to see how what it’s doing: it
will take a few minutes to download it. It’s a <code>tar.gz</code> file
and unfortunately, I am unaware of a way to stream tar data directly
into R, so <code>download_twenty_newsgroups</code> will download the
file to a temporary directory, extract everything, and attempt to clean
up afterwards. If something goes wrong it should log the directory it
downloaded to.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">ng20</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">18846</span>     <span class="dv">6</span></span></code></pre></div>
<p>The data is returned as a data frame with 6 columns:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ng20</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"Id"</span>        <span class="st">"FileId"</span>    <span class="st">"Text"</span>      <span class="st">"Subset"</span>    <span class="st">"Label"</span>     <span class="st">"Newsgroup"</span></span></code></pre></div>
<p>The <code>Id</code> column is a unique identifier for each post,
<code>FileId</code> is the filename combined with the
<code>Subset</code>, <code>Text</code> is the post text,
<code>Subset</code> is either <code>"train"</code> or
<code>"test"</code>, <code>Label</code> is the integer label of the
newsgroup and <code>Newsgroup</code> is the name of the newsgroup.</p>
<p>The columns we will be most interested in are the <code>Text</code>
and <code>Newsgroup</code>, and for some data manipulation we need to
do, the <code>Id</code> so we can keep track of the rows. Here’s the
first row without the <code>Text</code> column (we can safely ignore the
row id):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ng20</span><span class="op">[</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">3</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>                   Id FileId Subset Label   Newsgroup</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>alt.atheism<span class="fl">.1</span> train_1  <span class="dv">49960</span>  train     <span class="dv">0</span> alt.atheism</span></code></pre></div>
<p>And here’s the first few characters of the text:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">ng20</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">$</span><span class="va">Text</span>, <span class="fl">1</span>, <span class="fl">72</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"From: mathew &lt;mathew@mantis.co.uk&gt;</span><span class="sc">\n</span><span class="st">Subject: Alt.Atheism FAQ: Atheist Res"</span></span></code></pre></div>
<p>There is a <em>lot</em> more where that came from, which I invite you
to investigate (and fill your terminal with) yourself. Notably,
<code>snedata</code> doesn’t do any processing of the posts, so the
headers are still there, as are the footers and any other quotations of
previous posts that the current poster might be replying to.</p>
</div>
<div class="section level2">
<h2 id="preprocessing-the-data">Preprocessing the Data<a class="anchor" aria-label="anchor" href="#preprocessing-the-data"></a>
</h2>
<p>Unless you get very luck with pre-cleaned datasets, text data usually
requires a fair amount of processing to turn it into a vector of numbers
that UMAP can work on, so we will need to do some text wrangling to
start with. We’ll need to install <a href="https://dplyr.tidyverse.org/" class="external-link">dplyr</a>, <a href="https://tidyr.tidyverse.org/" class="external-link">tidyr</a> and <a href="https://stringr.tidyverse.org/" class="external-link">stringr</a>, for this:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"tidyr"</span>, <span class="st">"stringr"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span></code></pre></div>
<p><a href="https://www.tidytextmining.com/usenet#usenet" class="external-link">Text Mining
with R</a> is a good place to start to get some ideas of what to do, but
bear in mind the dataset is structured a bit differently, so let’s
temporarily expand the dataset by splitting the text on new lines like
in the tidy text mining example so that each row is a line in the
original post:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ng20spl</span> <span class="op">&lt;-</span> <span class="va">ng20</span> <span class="op">|&gt;</span> <span class="fu">separate_longer_delim</span><span class="op">(</span><span class="va">`Text`</span>, delim <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">ng20spl</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">834780</span>      <span class="dv">6</span></span></code></pre></div>
<p>Now the first row looks like:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ng20spl</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>       Id FileId                               Text Subset Label   Newsgroup</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="dv">1</span> train_1  <span class="dv">49960</span> From<span class="sc">:</span> mathew <span class="sc">&lt;</span>mathew<span class="sc">@</span>mantis.co.uk<span class="sc">&gt;</span>  train     <span class="dv">0</span> alt.atheism</span></code></pre></div>
<p>The first filtering is to remove headers (anything before the first
blank line) and footers (assumed to be anything after the first line of
repeated hyphens):</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cleaned_text</span> <span class="op">&lt;-</span> <span class="va">ng20spl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">`Newsgroup`</span>, <span class="va">`Id`</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">`Text`</span> <span class="op">==</span> <span class="st">""</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">`Text`</span>, <span class="st">"^--"</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">cleaned_text</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">599249</span>      <span class="dv">6</span></span></code></pre></div>
<p>And this attempts to removed quoted text:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cleaned_text</span> <span class="op">&lt;-</span> <span class="va">cleaned_text</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="fu">str_detect</span><span class="op">(</span><span class="va">`Text`</span>, <span class="st">"^[^&gt;]+[A-Za-z\\d]"</span><span class="op">)</span> <span class="op">|</span></span>
<span>      <span class="va">`Text`</span> <span class="op">==</span> <span class="st">""</span>,</span>
<span>    <span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">`Text`</span>, <span class="st">"writes(:|\\.\\.\\.)$"</span><span class="op">)</span>,</span>
<span>    <span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">`Text`</span>, <span class="st">"^In article &lt;"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">cleaned_text</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">445080</span>      <span class="dv">6</span></span></code></pre></div>
<p>These functions are a bit different from the ones used on the python
side by <a href="https://github.com/scikit-learn/scikit-learn/blob/3f89022fa04d293152f1d32fbc2a5bdaaf2df364/sklearn/datasets/_twenty_newsgroups.py" class="external-link">scikit-learn</a>
– see the functions <code>strip_newsgroup_header</code>,
<code>strip_newsgroup_quoting</code> and
<code>strip_newsgroup_footer</code>, but if the R functions are good
enough for the tidy text modelers, it’s good enough for me.</p>
<p>Also, in the tidy text book, they explicitly remove two items “that
contained a large amount of non-text content”. Specifically they are
images, and you can find out more about them in the “20 Newsgroups
Secrets” notebook linked above (don’t get too excited). There seems to
be other binary data in some of the posts, so to try and catch more, I
will end up filtering those out later.</p>
<p>The tidy text example goes on to examine the word frequencies for
each newsgroup as a whole, but we will go back to analyzing on a per
post basis. Now, having split the posts into lines, we need to unsplit
them, and also re-associate the other columns from the original
<code>ng20</code> data:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">text_unsplit</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">cleaned_text</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">`Id`</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>`Text` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">`Text`</span>, collapse <span class="op">=</span> <span class="st">" "</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">text_unsplit</span> <span class="op">&lt;-</span> <span class="va">ng20</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">`Text`</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">text_unsplit</span>, by <span class="op">=</span> <span class="st">"Id"</span><span class="op">)</span></span>
<span><span class="va">text_unsplit</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">text_unsplit</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Id"</span>, <span class="st">"FileId"</span>, <span class="st">"Text"</span>, <span class="st">"Subset"</span>, <span class="st">"Label"</span>, <span class="st">"Newsgroup"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">text_unsplit</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">18846</span>     <span class="dv">6</span></span></code></pre></div>
<p>Back to the original structure. This processing isn’t perfect, but it
should do a decent job. Now we can do some actual text processing.</p>
</div>
<div class="section level2">
<h2 id="text-mining">Text Mining<a class="anchor" aria-label="anchor" href="#text-mining"></a>
</h2>
<p>I’m going to use the <a href="https://cran.r-project.org/package=tm" class="external-link">tm</a> package for the text
mining:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"tm"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tm.r-forge.r-project.org/" class="external-link">tm</a></span><span class="op">)</span></span></code></pre></div>
<p>We are going to create a “corpus” from the text and then apply
various processing steps to normalize the text, such as handling
whitespace, case, removing punctuation and so on. When we create the
<code>Corpus</code> initially, we also convert the text encoding from
<code>latin1</code> to <code>UTF-8</code> via the <code>iconv</code>
function. As far as I can tell, the 20 Newsgroups data is in
<code>latin1</code> encoding (<code>sklearn</code> also reads them in
that encoding), which we will then convert to <code>UTF-8</code> for the
rest of the processing. There are still a few documents with odd
formatting characters but <code>tm</code> seems to deal with them
without issue.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">corpus</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">Corpus</span><span class="op">(</span><span class="fu">VectorSource</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/iconv.html" class="external-link">iconv</a></span><span class="op">(</span><span class="va">text_unsplit</span><span class="op">$</span><span class="va">Text</span>, <span class="st">"latin1"</span>, <span class="st">"UTF-8"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tm_map</span><span class="op">(</span><span class="fu">content_transformer</span><span class="op">(</span><span class="va">tolower</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tm_map</span><span class="op">(</span><span class="va">removePunctuation</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tm_map</span><span class="op">(</span><span class="va">removeNumbers</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tm_map</span><span class="op">(</span><span class="va">removeWords</span>, <span class="fu">stopwords</span><span class="op">(</span><span class="st">"english"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tm_map</span><span class="op">(</span><span class="va">stripWhitespace</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">corpus</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">18846</span></span></code></pre></div>
<div class="section level3">
<h3 id="filtering-out-bad-documents">Filtering Out Bad Documents<a class="anchor" aria-label="anchor" href="#filtering-out-bad-documents"></a>
</h3>
<p>At this point, I take a bit of inspiration from
<code>20 Newsgroups Secrets</code> and start looking at the distribution
of document lengths in terms of number of words and number of
characters. If our corpus really is mainly English text we would expect
to see some kind of rough relationship between these sorts of values and
any deviations are likely to be anomalies that need investigating.</p>
<p>This is a bit of a diversion from the business at hand, but we might
as well see if we can come up with some reasonable filter values using
some simple methods.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">count_words</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">doc</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">doc</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="st">" "</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">nwords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">corpus</span>, <span class="va">count_words</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">nwords</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>   Min. <span class="dv">1</span>st Qu.  Median    Mean <span class="dv">3</span>rd Qu.    Max. </span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>   <span class="fl">0.00</span>   <span class="fl">24.00</span>   <span class="fl">46.00</span>   <span class="fl">84.42</span>   <span class="fl">86.00</span> <span class="fl">6592.00</span> </span></code></pre></div>
<p>Clearly there is quite a skew in terms of the number of words. Some
messages now have zero words, and one has nearly 7000. But the median is
less than 50 words. Let’s look at the distribution of the number of
words, but stop at 95% of the data to avoid the outliers:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">nwords</span><span class="op">[</span><span class="va">nwords</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">nwords</span>, <span class="fl">0.95</span><span class="op">)</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"0-95% word count distribution"</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="img/sparse-data-example/word-dist.png" alt="0-95% word count distribution"><div class="figcaption">0-95% word count distribution</div>
</div>
<p>So 95% of the data contains 250 words or less.</p>
<p>What is this massive document? Let’s (carefully) take a look:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">ng20</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">nwords</span><span class="op">)</span>, <span class="op">]</span><span class="op">$</span><span class="va">Text</span>, <span class="fl">0</span>, <span class="fl">80</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"From: jeh@cmkrnl.com</span><span class="sc">\n</span><span class="st">Subject: Electrical wiring FAQ (was: A question about 120VA"</span></span></code></pre></div>
<p>Ah, it’s a FAQ. Ok that makes sense. Now let’s look at the
distribution of the raw length of the documents in terms of number of
characters:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nchars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">corpus</span>, <span class="kw">function</span><span class="op">(</span><span class="va">doc</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">doc</span> <span class="op">|&gt;</span> <span class="fu">str_length</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">nchars</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>   Min. <span class="dv">1</span>st Qu.  Median    Mean <span class="dv">3</span>rd Qu.    Max. </span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>    <span class="fl">0.0</span>   <span class="fl">158.0</span>   <span class="fl">310.0</span>   <span class="fl">594.6</span>   <span class="fl">593.0</span> <span class="fl">67441.0</span> </span></code></pre></div>
<p>Seems reminiscent of the word count distribution. So let’s see how
related they are (you’d assume very related but you never know):</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">nwords</span>, <span class="va">nchars</span>, main <span class="op">=</span> <span class="st">"Number of words vs number of characters"</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="img/sparse-data-example/word-char-correlation.png" alt="Number of words vs number of characters"><div class="figcaption">Number of words vs number of characters</div>
</div>
<p>Ok that’s a very good relation, which makes those documents which
don’t appear on the main trendline all the more suspicious. The easy way
to deal with this is to define an average word length:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avg_word_lengths</span> <span class="op">&lt;-</span> <span class="va">nchars</span> <span class="op">/</span> <span class="va">nwords</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">avg_word_lengths</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>   Min. <span class="dv">1</span>st Qu.  Median    Mean <span class="dv">3</span>rd Qu.    Max.    NA<span class="st">'s </span></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a><span class="st">  1.000   6.294   6.750   6.720   7.213  27.533      77 </span></span></code></pre></div>
<p>Those <code>NA</code>’s are the documents with zero words. This looks
like another rather skewed distribution:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">avg_word_lengths</span><span class="op">[</span><span class="va">avg_word_lengths</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">avg_word_lengths</span>, <span class="fl">0.95</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"0-95% average word length distribution"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="img/sparse-data-example/avg-word-length-dist.png" alt="0-95% average word length distribution"><div class="figcaption">0-95% average word length distribution</div>
</div>
<p>So 95% of the data has an average word length of 8 or less.</p>
<p>This gives us a bit of a feel for what might be some reasonable
filter settings to get rid of unsuitable data. The filters established
by <code>20 Newsgroups Secrets</code> for document length based on word
seem reasonable here: less than 10 words is suspicious and 2000 or more
words is also suspicious.</p>
<p>To avoid making this even longer than it needs to be, I won’t be
investigating the suspicious documents in this article.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">is_suspiciously_short</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">doc</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">doc</span> <span class="op">|&gt;</span> <span class="fu">count_words</span><span class="op">(</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">9</span></span>
<span><span class="op">}</span></span>
<span><span class="va">suspiciously_short_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">corpus</span>, <span class="va">is_suspiciously_short</span><span class="op">)</span></span>
<span><span class="va">corpus</span> <span class="op">&lt;-</span> <span class="va">corpus</span><span class="op">[</span><span class="op">!</span><span class="va">suspiciously_short_indices</span><span class="op">]</span></span>
<span><span class="va">text_unsplit</span> <span class="op">&lt;-</span> <span class="va">text_unsplit</span><span class="op">[</span><span class="op">!</span><span class="va">suspiciously_short_indices</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">corpus</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">17708</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">is_suspiciously_long</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">doc</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">doc</span> <span class="op">|&gt;</span> <span class="fu">count_words</span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2000</span></span>
<span><span class="op">}</span></span>
<span><span class="va">suspiciously_long_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">corpus</span>, <span class="va">is_suspiciously_long</span><span class="op">)</span></span>
<span><span class="va">corpus</span> <span class="op">&lt;-</span> <span class="va">corpus</span><span class="op">[</span><span class="op">!</span><span class="va">suspiciously_long_indices</span><span class="op">]</span></span>
<span><span class="va">text_unsplit</span> <span class="op">&lt;-</span> <span class="va">text_unsplit</span><span class="op">[</span><span class="op">!</span><span class="va">suspiciously_long_indices</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">corpus</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">17675</span></span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avg_word_len</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">doc</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="op">(</span><span class="va">doc</span> <span class="op">|&gt;</span> <span class="fu">str_length</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">doc</span> <span class="op">|&gt;</span> <span class="fu">count_words</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">has_suspiciously_short_words</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">doc</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">doc</span> <span class="op">|&gt;</span> <span class="fu">avg_word_len</span><span class="op">(</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">4</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">suspiciously_short_word_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">corpus</span>, <span class="va">has_suspiciously_short_words</span><span class="op">)</span></span>
<span><span class="va">corpus</span> <span class="op">&lt;-</span> <span class="va">corpus</span><span class="op">[</span><span class="op">!</span><span class="va">suspiciously_short_word_indices</span><span class="op">]</span></span>
<span><span class="va">text_unsplit</span> <span class="op">&lt;-</span> <span class="va">text_unsplit</span><span class="op">[</span><span class="op">!</span><span class="va">suspiciously_short_word_indices</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">corpus</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">17670</span></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">has_suspiciously_long_words</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">doc</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">doc</span> <span class="op">|&gt;</span> <span class="fu">avg_word_len</span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">15</span></span>
<span><span class="op">}</span></span>
<span><span class="va">suspiciously_long_word_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">corpus</span>, <span class="va">has_suspiciously_long_words</span><span class="op">)</span></span>
<span><span class="va">corpus</span> <span class="op">&lt;-</span> <span class="va">corpus</span><span class="op">[</span><span class="op">!</span><span class="va">suspiciously_long_word_indices</span><span class="op">]</span></span>
<span><span class="va">text_unsplit</span> <span class="op">&lt;-</span> <span class="va">text_unsplit</span><span class="op">[</span><span class="op">!</span><span class="va">suspiciously_long_word_indices</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">corpus</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">17666</span></span></code></pre></div>
<p>Ok, I think we’ve done enough to move on.</p>
</div>
</div>
<div class="section level2">
<h2 id="tf-idf">TF-IDF<a class="anchor" aria-label="anchor" href="#tf-idf"></a>
</h2>
<p>The next step is to convert the corpus into a matrix of TF-IDF
values:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tfidf</span> <span class="op">&lt;-</span> <span class="fu">weightTfIdf</span><span class="op">(</span><span class="fu">DocumentTermMatrix</span><span class="op">(</span><span class="va">corpus</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">tfidf</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">17666</span> <span class="dv">88894</span></span></code></pre></div>
<p>Nearly 90,000 dimensions, each one a weighted word frequency. How
sparse is it:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/nnzero.html" class="external-link">nnzero</a></span><span class="op">(</span><span class="va">tfidf</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">tfidf</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">0.0006920568</span></span></code></pre></div>
<p>so less than 0.1% of the matrix is non-zero.</p>
<p>One way to proceed at this point would be to use a SVD that can work
on sparse matrices, such as <a href="https://cran.r-project.org/package=irlba" class="external-link">irlba</a>, and turn this
into a dense representation with far fewer dimensions. However this is
slow and takes up a lot of memory and you have to spend time working out
how many dimensions to use, which slows things down even more if you
don’t get it right the first time.</p>
<p>Fortunately, now that <code>uwot</code> can use
<code>rnndescent</code>, we can work on the sparse data directly.</p>
</div>
<div class="section level2">
<h2 id="umap-with-nn-descent">UMAP with NN-Descent<a class="anchor" aria-label="anchor" href="#umap-with-nn-descent"></a>
</h2>
<p>To use <code>uwot</code> with sparse data we need to convert the
TF-IDF matrix into a format from the <a href="https://cran.r-project.org/package=Matrix" class="external-link">Matrix</a> package that
<code>rnndescent</code> can handle:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span></span>
<span><span class="va">tfidf_sp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/sparseMatrix.html" class="external-link">sparseMatrix</a></span><span class="op">(</span></span>
<span>    i <span class="op">=</span> <span class="va">tfidf</span><span class="op">$</span><span class="va">i</span>,</span>
<span>    j <span class="op">=</span> <span class="va">tfidf</span><span class="op">$</span><span class="va">j</span>,</span>
<span>    x <span class="op">=</span> <span class="va">tfidf</span><span class="op">$</span><span class="va">v</span>,</span>
<span>    dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">tfidf</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>For historical reasons to do with not breaking backwards
compatibility, we can’t use the <code>umap</code> function with sparse
input data. Instead we will use the <code>umap2</code> function, which
is a newer version of <code>umap</code> but with slightly better
defaults and which can take sparse matrix input. We also need to load
the <code>rnndescent</code> package.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"rnndescent"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jlmelville.github.io/rnndescent/" class="external-link">rnndescent</a></span><span class="op">)</span></span></code></pre></div>
<p>In terms of non-default options, I’m going to use the
<code>batch = TRUE</code> setting, a longer than usual optimization, and
a non-zero <code>dens_scale</code> to model some of the original density
differences in the data (see the article on <a href="https://jlmelville.github.io/uwot/articles/leopold.html">LEOPOLD</a>
for more details). I will also save the nearest neighbors with
<code>ret_nn = TRUE</code> so I can compare them with the exact results
we will calculate later.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jlmelville/uwot" class="external-link">uwot</a></span><span class="op">)</span></span>
<span><span class="va">ng20_umap</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/umap2.html">umap2</a></span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="va">tfidf_sp</span>,</span>
<span>    nn_method <span class="op">=</span> <span class="st">"nndescent"</span>,</span>
<span>    metric <span class="op">=</span> <span class="st">"hellinger"</span>,</span>
<span>    n_epochs <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    batch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    dens_scale <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    ret_nn <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code>Using nndescent for nearest neighbor search
UMAP embedding parameters a = 1.577 b = 0.8951
Read 17666 rows and found 88894 numeric columns
Using alt metric 'alternative-hellinger' for 'hellinger'
Initializing neighbors using 'tree' method
Calculating rp tree k-nearest neighbors with k = 15 n_trees = 17 max leaf size = 15 margin = 'explicit' using 6 threads
Using angular margin calculation
0%   10   20   30   40   50   60   70   80   90   100%
[----|----|----|----|----|----|----|----|----|----]
***************************************************
Extracting leaf array from forest
Creating knn using 32172 leaves
0%   10   20   30   40   50   60   70   80   90   100%
[----|----|----|----|----|----|----|----|----|----]
***************************************************
Running nearest neighbor descent for 14 iterations using 6 threads
0%   10   20   30   40   50   60   70   80   90   100%
[----|----|----|----|----|----|----|----|----|----]
***************************************************
Convergence: c = 170 tol = 264.99
Finished
Commencing smooth kNN distance calibration using 6 threads with target n_neighbors = 15
17 smooth knn distance failures
Initializing from normalized Laplacian + noise (using irlba)
Range-scaling initial input columns to 0-10
Commencing optimization for 1000 epochs, with 389106 positive edges using 6 threads
Using method 'leopold'
Optimizing with Adam alpha = 1 beta1 = 0.5 beta2 = 0.9 eps = 1e-07
0%   10   20   30   40   50   60   70   80   90   100%
[----|----|----|----|----|----|----|----|----|----|
**************************************************|
Optimization finished</code></pre>
<p>If you follow along with the code here, you will <em>not</em> get the
exact same results as me when you plot them below, due to the stochastic
nature of UMAP. But you should see something similar (if you don’t,
please <a href="https://github.com/jlmelville/uwot/issues" class="external-link">file an
issue</a>).</p>
</div>
<div class="section level2">
<h2 id="plot-the-results">Plot the Results<a class="anchor" aria-label="anchor" href="#plot-the-results"></a>
</h2>
<p>This is going to be a bit challenging to plot, as we have to have 20
unique colors for the 20 newsgroups. Most palettes don’t offer anything
of that size, so I am going to use the <a href="https://cran.r-project.org/package=Polychrome" class="external-link">Polychrome</a>
package to generate a palette with 20 colors which are hopefully
reasonably distinguishable. This is a similar approach to the Python
package <a href="https://github.com/lmcinnes/glasbey" class="external-link">glasbey</a>.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://oompa.r-forge.r-project.org/" class="external-link">Polychrome</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="va">palette</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu">Polychrome</span><span class="fu">::</span><span class="fu">createPalette</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">text_unsplit</span><span class="op">$</span><span class="va">Newsgroup</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span>,</span>
<span>  seedcolors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#ffffff"</span>, <span class="st">"#000000"</span><span class="op">)</span>,</span>
<span>  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">90</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>I will also rotate the coordinates so they align along the principal
axes:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ng20_umap_rotated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">ng20_umap</span><span class="op">$</span><span class="va">embedding</span><span class="op">)</span><span class="op">$</span><span class="va">x</span></span></code></pre></div>
<p>Ok, now to make the plot with <a href="https://ggplot2.tidyverse.org/" class="external-link">ggplot2</a>:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">ng20_umap_rotated</span>, Newsgroup <span class="op">=</span> <span class="va">text_unsplit</span><span class="op">$</span><span class="va">Newsgroup</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PC1</span>, y <span class="op">=</span> <span class="va">PC2</span>, color <span class="op">=</span> <span class="va">Newsgroup</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.4</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">palette</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Sparse Hellinger NN-Descent 20Newsgroups UMAP"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">""</span>,</span>
<span>    y <span class="op">=</span> <span class="st">""</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Newsgroup"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="img/sparse-data-example/ng20-umap2.png" alt="UMAP"><div class="figcaption">UMAP</div>
</div>
<p>Although we can’t compare this result too easily with the Python
example, as that one plots the training and test set separately, and
there isn’t a legend, I think this has done a pretty good job of
separating at least some of the 20 newsgroups.</p>
</div>
<div class="section level2">
<h2 id="finding-exact-nearest-neighbors">Finding Exact Nearest Neighbors<a class="anchor" aria-label="anchor" href="#finding-exact-nearest-neighbors"></a>
</h2>
<p>Before <code>uwot</code> supported using <code>rnndescent</code>
internally for sparse data, this article documented the process of using
<code>rnndesent</code> directly with the 20 Newsgroups data and then
integrating that with the <code>umap</code> function. This is still a
perfectly viable approach, especially if you want to use exact nearest
neighbors. <code>uwot</code> uses the nearest neighbor descent method to
find approximate nearest neighbors, which is faster but not exact. In
what follows we’ll use <code>rnndescent</code> to find exact nearest
neighbors by a brute force method and then see what sort of difference
that makes to the UMAP result.</p>
<p>I’ll assume you’ve been following along so far, so that we have the
L1-normalized TF-IDF matrix <code>tfidf_spl1</code> and
<code>rnndescent</code> loaded. Now let’s use the brute-force search in
<code>rnndescent</code>. This dataset is small enough for us to handle
an exact search comfortably, at least if you have enough cores:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tfidfl1_hell_bf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/brute_force_knn.html" class="external-link">brute_force_knn</a></span><span class="op">(</span></span>
<span>    <span class="va">tfidf_sp</span>,</span>
<span>    k <span class="op">=</span> <span class="fl">15</span>,</span>
<span>    metric <span class="op">=</span> <span class="st">"hellinger"</span>,</span>
<span>    n_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code>Using alt metric 'alternative-hellinger' for 'hellinger'
Calculating brute force k-nearest neighbors with k = 15 using 6 threads
0%   10   20   30   40   50   60   70   80   90   100%
[----|----|----|----|----|----|----|----|----|----]
***************************************************
Finished</code></pre>
<p>This took about 35 seconds on my machine, whereas nearest neighbor
descent only took about 5 seconds. That said, in this case I am happy to
pay the price of the extra 30 seconds to avoid any issues due to
approximation.</p>
</div>
<div class="section level2">
<h2 id="umap-with-exact-neighbors">UMAP with Exact Neighbors<a class="anchor" aria-label="anchor" href="#umap-with-exact-neighbors"></a>
</h2>
<p>We can now run UMAP with the exact neighbors. I will use the same
parameters in conjunction with <code>umap2</code> as I did with the
approximate nearest neighbors:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ng20_umap_exact</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/umap2.html">umap2</a></span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    nn_method <span class="op">=</span> <span class="va">tfidfl1_hell_bf</span>,</span>
<span>    n_epochs <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    batch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    dens_scale <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code>UMAP embedding parameters a = 1.577 b = 0.8951
Commencing smooth kNN distance calibration using 6 threads with target n_neighbors = 15
16 smooth knn distance failures
Initializing from normalized Laplacian + noise (using irlba)
Range-scaling initial input columns to 0-10
Commencing optimization for 1000 epochs, with 377272 positive edges using 6 threads
Using method 'leopold'
Optimizing with Adam alpha = 1 beta1 = 0.5 beta2 = 0.9 eps = 1e-07
0%   10   20   30   40   50   60   70   80   90   100%
[----|----|----|----|----|----|----|----|----|----|
**************************************************|
Optimization finished</code></pre>
</div>
<div class="section level2">
<h2 id="plot-the-exact-neighbors-umap-results">Plot the Exact Neighbors UMAP Results<a class="anchor" aria-label="anchor" href="#plot-the-exact-neighbors-umap-results"></a>
</h2>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">ng20_umap_exact</span><span class="op">)</span><span class="op">$</span><span class="va">x</span>, Newsgroup <span class="op">=</span> <span class="va">text_unsplit</span><span class="op">$</span><span class="va">Newsgroup</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PC1</span>, y <span class="op">=</span> <span class="va">PC2</span>, color <span class="op">=</span> <span class="va">Newsgroup</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.4</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">palette</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Sparse Hellinger Exact Neighbors 20Newsgroups UMAP"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">""</span>,</span>
<span>    y <span class="op">=</span> <span class="st">""</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Newsgroup"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="img/sparse-data-example/ng20-umap2-exact.png" alt="UMAP-exact-15"><div class="figcaption">UMAP-exact-15</div>
</div>
<p>Actually, although the plots share a lot of the same features there
are some noticeable differences to some of the cluster placements.</p>
</div>
<div class="section level2">
<h2 id="hubness">Hubness<a class="anchor" aria-label="anchor" href="#hubness"></a>
</h2>
<p>What’s going on here? If you want, you can re-run the UMAP with the
exact nearest neighbors a few times, which will tell us how much the
result varies due to the random selection during negative sampling. I
will leave that as an exercise for you. Having tried it myself, the plot
is pretty stable (the <code>sci.space</code> cluster moves between two
locations). So the reason for the differences is going to be down to the
performance of the approximate nearest neighbors. As we have gone to the
trouble of generating the exact nearest neighbors we can answer the
question of how well did we actually do in reproducing the exact
neighbors? <code>rnndescent</code> has a <code>neighbor_overlap</code>
function we can use which will return a value of 0 (no overlap between
two sets of neighbors) and 1 (perfect overlap):</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/neighbor_overlap.html" class="external-link">neighbor_overlap</a></span><span class="op">(</span><span class="va">ng20_umap</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">hellinger</span>, <span class="va">tfidfl1_hell_bf</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] 0.7484169</code></pre>
<p>So about 75% accuracy, that’s less than the 90% that I would usually
be happier with. I’m not totally surprised as high dimensional datasets
tend to contain “hubs” (items which appear on the nearest neighbor lists
of many other items) and these tend to make it hard for any approximate
nearest neighbor method to do a good exploration. Does this combination
of dataset, <code>n_neighbors</code> and <code>metric</code> result in
the neighbors having a hub. Once again <code>rnndescent</code> can help
us with its <code>k_occur</code> function which will count the
k-occurrence for each item: the number of times an item appears in the
nearest neighbor lists of other items (aka the number of reverse
neighbors). The hubness for a dataset can be defined as the maximum
number of times any item appears in the k-occurrence list, and I am
going to normalize that with respect to <code>n_neighbors</code>:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tfidfl1_hell_bf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/k_occur.html" class="external-link">k_occur</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="fl">15</span></span></code></pre></div>
<pre><code><span><span class="fl">20.13333</span></span></code></pre>
<p>A dataset where each item gets its fair share of reverse neighbors
would result in a maximum k-occurrence of <code>n_neighbors</code>, or
in this case a normalized hubness of 1. So we are at a much larger value
than that. My own personal experience is that if the normalized hubness
exceeds 10, then approximate nearest neighbors methods will struggle to
do well, at least if you are looking for relatively low values of
<code>n_neighbors</code> with default settings. Incidentally, you don’t
need the exact nearest neighbors to detect hubness, the approximate
results will also act as a good diagnostic:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ng20_umap</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">hellinger</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/k_occur.html" class="external-link">k_occur</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="fl">15</span></span></code></pre></div>
<pre><code><span><span class="fl">30.46667</span></span></code></pre>
<p>Not necessarily good at reproducing the result from the exact
neighbors, but it will certainly tell you that something is up.</p>
</div>
<div class="section level2">
<h2 id="umap-with-more-neighbors">UMAP with More Neighbors<a class="anchor" aria-label="anchor" href="#umap-with-more-neighbors"></a>
</h2>
<p>So what are we going to do about this? In these cases, usually
increasing <code>n_neighbors</code> helps. I’m going to look at
<code>n_neighbors = 50</code>. We will also want the equivalent brute
force results to see if it helped:</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tfidfl1_hell_bf_50</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/brute_force_knn.html" class="external-link">brute_force_knn</a></span><span class="op">(</span></span>
<span>        <span class="va">tfidf_sp</span>,</span>
<span>        k <span class="op">=</span> <span class="fl">50</span>,</span>
<span>        metric <span class="op">=</span> <span class="st">"hellinger"</span>,</span>
<span>        n_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>        verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>Let’s see what’s up with the hubness:</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tfidfl1_hell_bf_50</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/k_occur.html" class="external-link">k_occur</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="fl">50</span></span></code></pre></div>
<pre><code>[1] 20.1</code></pre>
<p>Not that different to the <code>n_neighbors = 15</code> result, but I
have more confidence that nearest neighbor descent will be able to
handle this level of hubness given the larger <code>n_neighbors</code>
value. But let’s find out.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ng20_umap_50</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="../reference/umap2.html">umap2</a></span><span class="op">(</span></span>
<span>        X <span class="op">=</span> <span class="va">tfidf_sp</span>,</span>
<span>        nn_method <span class="op">=</span> <span class="st">"nndescent"</span>,</span>
<span>        metric <span class="op">=</span> <span class="st">"hellinger"</span>,</span>
<span>        n_neighbors <span class="op">=</span> <span class="fl">50</span>,</span>
<span>        n_epochs <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>        batch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        dens_scale <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>        ret_nn <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ng20_umap_50</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">hellinger</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/k_occur.html" class="external-link">k_occur</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="fl">50</span></span></code></pre></div>
<pre><code>[1] 21.12</code></pre>
<p>A similar level of hubness reported, but more importantly, what’s the
accuracy like?</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/neighbor_overlap.html" class="external-link">neighbor_overlap</a></span><span class="op">(</span><span class="va">ng20_umap_50</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">hellinger</span>, <span class="va">tfidfl1_hell_bf_50</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] 0.9553753</code></pre>
<p>96%! Much better. Let’s see how the UMAP plot looks:</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">ng20_umap_50</span><span class="op">$</span><span class="va">embedding</span><span class="op">)</span><span class="op">$</span><span class="va">x</span>, Newsgroup <span class="op">=</span> <span class="va">text_unsplit</span><span class="op">$</span><span class="va">Newsgroup</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PC1</span>, y <span class="op">=</span> <span class="va">PC2</span>, color <span class="op">=</span> <span class="va">Newsgroup</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.4</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">palette</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Sparse Hellinger Approximate 50-Neighbors 20Newsgroups UMAP"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">""</span>,</span>
<span>    y <span class="op">=</span> <span class="st">""</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Newsgroup"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="img/sparse-data-example/ng20-umap2-50.png" alt="UMAP-50"><div class="figcaption">UMAP-50</div>
</div>
<p>Well, the clusters have spread out a bit (expected due to the 3-fold
increase in <code>n_neighbors</code>) but they have also continued to
move around a bit compared to the <code>n_neighbors = 15</code> result.
Hmm, let’s see if at least we have agreement with the exact case for
<code>n_neighbors = 50</code>:</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ng20_umap_exact_50</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="../reference/umap2.html">umap2</a></span><span class="op">(</span></span>
<span>        X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>        nn_method <span class="op">=</span> <span class="va">tfidfl1_hell_bf_50</span>,</span>
<span>        n_epochs <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>        batch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        dens_scale <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>        verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">ng20_umap_exact_50</span><span class="op">)</span><span class="op">$</span><span class="va">x</span>, Newsgroup <span class="op">=</span> <span class="va">text_unsplit</span><span class="op">$</span><span class="va">Newsgroup</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PC1</span>, y <span class="op">=</span> <span class="va">PC2</span>, color <span class="op">=</span> <span class="va">Newsgroup</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.4</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">palette</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"Sparse Hellinger Exact 50-Neighbors 20Newsgroups UMAP"</span>,</span>
<span>        x <span class="op">=</span> <span class="st">""</span>,</span>
<span>        y <span class="op">=</span> <span class="st">""</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"Newsgroup"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="img/sparse-data-example/ng20-umap2-exact-50.png" alt="UMAP-exact-50"><div class="figcaption">UMAP-exact-50</div>
</div>
<p>Again, some of the clusters are on the move compared to the
approximate case. It seems that the locations of <code>sci.crypt</code>
and the <code>rec.sports.baseball</code>/<code>rec.sports.hockey</code>
pair are particularly sensitive.</p>
</div>
<div class="section level2">
<h2 id="umap-with-even-more-neighbors">UMAP with Even More Neighbors<a class="anchor" aria-label="anchor" href="#umap-with-even-more-neighbors"></a>
</h2>
<p>The next step would be to increase <code>n_neighbors</code> even
further and see if results are more stable. The maximum I usually
consider is <code>n_neighbors = 150</code>: this is the sort of number
that would be used by methods like t-SNE with a fairly large perplexity
of 50. Fortunately, in my testing the results for this value of
<code>n_neighbors</code> actually <em>are</em> stable so we don’t need
to go higher this time. To get something that visually resembles the
original <code>n_neighbors = 15</code> result, my strategy is to run
UMAP with progressively smaller values of <code>n_neighbors</code> using
the output of the previous run as the initialization. This isn’t as time
consuming as it could be because we only need to do the nearest neighbor
search once and the optimizations before the final step can use the
faster t-UMAP gradient, which will be used by <code>umap2</code> if it
detects <code>a = 1</code> and <code>b = 1</code> being passed. The
following uses <code>n_neighbors = 150</code>,
<code>n_neighbors = 50</code> and then finished off at
<code>n_neighbors = 15</code>:</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ng20_umap_150</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap2.html">umap2</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">tfidf_sp</span>,</span>
<span>  nn_method <span class="op">=</span> <span class="st">"nndescent"</span>,</span>
<span>  metric <span class="op">=</span> <span class="st">"hellinger"</span>,</span>
<span>  n_epochs <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  batch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  n_neighbors <span class="op">=</span> <span class="fl">150</span>,</span>
<span>  a <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  b <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  ret_nn <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ng20_umap_150_50</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap2.html">umap2</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">tfidf_sp</span>,</span>
<span>  nn_method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    idx <span class="op">=</span> <span class="va">ng20_umap_150</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">hellinger</span><span class="op">$</span><span class="va">idx</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">]</span>,</span>
<span>    dist <span class="op">=</span> <span class="va">ng20_umap_150</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">hellinger</span><span class="op">$</span><span class="va">dist</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">]</span></span>
<span>  <span class="op">)</span>,</span>
<span>  n_epochs <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  batch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  a <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  b <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  init <span class="op">=</span> <span class="va">ng20_umap_150</span><span class="op">$</span><span class="va">embedding</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ng20_umap_150_50_15</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap2.html">umap2</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">tfidf_sp</span>,</span>
<span>  nn_method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    idx <span class="op">=</span> <span class="va">ng20_umap_150</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">hellinger</span><span class="op">$</span><span class="va">idx</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">]</span>,</span>
<span>    dist <span class="op">=</span> <span class="va">ng20_umap_150</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">hellinger</span><span class="op">$</span><span class="va">dist</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">]</span></span>
<span>  <span class="op">)</span>,</span>
<span>  n_epochs <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  batch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  dens_scale <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  init <span class="op">=</span> <span class="va">ng20_umap_150_50</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">ng20_umap_150_50_15</span><span class="op">)</span><span class="op">$</span><span class="va">x</span>, Newsgroup <span class="op">=</span> <span class="va">text_unsplit</span><span class="op">$</span><span class="va">Newsgroup</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PC1</span>, y <span class="op">=</span> <span class="va">PC2</span>, color <span class="op">=</span> <span class="va">Newsgroup</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.4</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">palette</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"Sparse Hellinger Exact 150-to-15 20Newsgroups UMAP"</span>,</span>
<span>        x <span class="op">=</span> <span class="st">""</span>,</span>
<span>        y <span class="op">=</span> <span class="st">""</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"Newsgroup"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="img/sparse-data-example/ng20-umap2-150-15.png" alt="UMAP-150-15"> This strategy can work well if you can find a
suitable starting value for <code>n_neighbors</code> that isn’t too
onerous. Bear in mind that quite apart from the computational cost of
finding a large number of neighbors and the consequent increase in
number of edges that need optimizing, a more “global” setting is not
always better as you could be short-circuiting the manifold structure of
the data. It seems to have worked out in this case, though, and repeated
runs give a layout which is much more stable than the original
<code>n_neighbors = 15</code> case.</p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>If you install <code>rnndescent</code> and use the <code>umap2</code>
function, it’s possible to embed sparse high-dimensional datasets using
UMAP and you can even use relatively exotic metrics like Hellinger
divergence.</p>
<p>Be aware that high-dimensional datasets can contain hubs. For low
values of <code>n_neighbors</code>, you may not get as high nearest
neighbor accuracies as you are used to. <code>rnndescent</code> has
functions which can help detect hubness. Increasing
<code>n_neighbors</code> can help, but you should still be wary of
over-interpreting the relative positions of clusters in the output. Yes,
I know everyone says this but it bears repeating because the temptation
is always there. I recommend re-running your UMAP results multiple times
with any given settings, even if you have exact nearest neighbors, and
you should also repeat with different values of <code>n_neighbors</code>
(e.g. <code>50</code> and/or <code>150</code>). “Annealing” the
<code>n_neighbors</code> value down in a series of optimizations can
work out well.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by James Melville.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>

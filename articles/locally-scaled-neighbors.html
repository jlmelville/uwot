<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Locally Scaled Neighbors • uwot</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Locally Scaled Neighbors">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">uwot</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/uwot.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jlmelville/uwot/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Locally Scaled Neighbors</h1>
            
            <h4 data-toc-skip class="date">December 26 2024</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jlmelville/uwot/blob/master/vignettes/articles/locally-scaled-neighbors.Rmd" class="external-link"><code>vignettes/articles/locally-scaled-neighbors.Rmd</code></a></small>
      <div class="d-none name"><code>locally-scaled-neighbors.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In their paper on <a href="https://papers.nips.cc/paper_files/paper/2004/hash/40173ea48d9567f1f393b20c855bb40b-Abstract.html" class="external-link">Self-Tuning
Spectral Clustering</a>, Zelnik-Manor and Perona describe a method of
local scaling to determining the affinity (similarity) between two data
points. This is defined as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>A</mi><mo accent="true">̂</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mo>−</mo><mfrac><msubsup><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow><mn>2</mn></msubsup><mrow><msub><mi>σ</mi><mi>i</mi></msub><msub><mi>σ</mi><mi>j</mi></msub></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\hat{A}_{ij} = \exp\left(-\frac{d^2_{ij}}{\sigma_{i} \sigma_{j}}\right)
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">d_{ij}</annotation></semantics></math>
is the distance between points
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\sigma_i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><mi>j</mi></msub><annotation encoding="application/x-tex">\sigma_j</annotation></semantics></math>
are local scaling factors for points
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
respectively. Previous methods had suggested empirically selecting a
fixed value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
for the entire dataset, whereas Zelnik-Manor and Perona suggest that
there should be a per-point scaling factor, based on the local density
around each point. To choose the local scaling factor, the authors
suggest “studying the local statistics of the neighborhood” around each
point. In their studies they use the distance to the 7th neighbor.</p>
<p>Although there is clearly a connection here between the local scaling
factor and the perplexity parameter in t-SNE, this specific method was
not used in dimensionality reduction until the introduction of <a href="https://arxiv.org/abs/1910.00204" class="external-link">TriMap</a> where it was used as
part of the weighting scheme in its triplet-based loss function,
although the local scaling factor was modified to be the average of the
4th-6th neighbor distances.</p>
</div>
<div class="section level2">
<h2 id="locally-scaled-nearest-neighbors">Locally Scaled Nearest Neighbors<a class="anchor" aria-label="anchor" href="#locally-scaled-nearest-neighbors"></a>
</h2>
<p>Later, <a href="https://jmlr.org/papers/v22/20-1061.html" class="external-link">PaCMAP</a>
adopted TriMap’s local scaling as a way of picking nearest neighbors
rather than using the k-nearest neighbors directly. The rationale given
in the paper is “the scaling is performed to account for the fact that
neighborhoods in different parts of the feature space could be of
significantly different magnitudes”.</p>
<p>Here’s how you do it:</p>
<ol style="list-style-type: decimal">
<li>Select a number of neighbors
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>.
By default, this is determined based on the number of points in the
dataset, but is on the order of the UMAP default of
<code>n_neighbors = 15</code>.</li>
<li>Select a number of “extended” neighbors,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mi>′</mi></mrow><annotation encoding="application/x-tex">k'</annotation></semantics></math>.
This is set to 50.</li>
<li>Find the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>+</mo><mi>k</mi><mi>′</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k + k' + 1</annotation></semantics></math>
nearest neighbors for each point. The <code>+ 1</code> bit is to account
for the fact that the self-neighbor is included in the nearest neighbor
list (this is an implementation detail of the PaCMAP code and not
explicitly mentioned in the paper but makes sense).</li>
<li>For each of the extended nearest neighbors, calculate the
locally-scaled distances as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow><mn>2</mn></msubsup><mi>/</mi><msub><mi>σ</mi><mi>i</mi></msub><msub><mi>σ</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">d^2_{ij}/\sigma_{i} \sigma_{j}</annotation></semantics></math>
with the same definition for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\sigma_i</annotation></semantics></math>
as in TriMap. Once again, because of the self-neighbor, we need to use
one more neighbor than mentioned in the paper, so in terms of UMAP, we
actually use the average distance of the fifth-to-seventh nearest
neighbors to define
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\sigma_i</annotation></semantics></math>.</li>
<li>Return the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
nearest neighbors based on the locally-scaled distances.</li>
</ol>
<p>PaCMAP does not actually make use of the distances from the near
neighbors, but the paper stresses that the scaled distances “are used
only for selecting neighbors; they are not used during
optimization”.</p>
<p>I am curious about whether using the locally scaled neighbors for
UMAP neighbor graph provides any benefit, although the PaCMAP paper
doesn’t mention them or their effect in any of the discussion of the
method’s performance. Having to calculate an extra 50 nearest neighbors
is a bit of a computational burden, and may have motivated why PaCMAP
will warn you about a slow nearest neighbor search if you turn off the
default PCA preprocessing step. However, calculating on the order of ~65
nearest neighbors, while more than a typical UMAP run, would be typical
(or even a little low) compared to a t-SNE run.</p>
</div>
<div class="section level2">
<h2 id="locally-scaled-nn-implementation">Locally Scaled NN Implementation<a class="anchor" aria-label="anchor" href="#locally-scaled-nn-implementation"></a>
</h2>
<p>Below is some code to generate a LSNN graph for use with
<code>uwot</code>. Use <code>locally_scaled_knn</code> to create it from
an input dataframe, e.g.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lsnn15</span> <span class="op">&lt;-</span> <span class="fu">locally_scaled_knn</span><span class="op">(</span><span class="va">data</span>, n_neighbors <span class="op">=</span> <span class="fl">15</span>, n_extra <span class="op">=</span> <span class="fl">50</span>, n_threads <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<p>If you set <code>nn_kind = "exact"</code> you can get out the exact
nearest neighbors, but that will be slow.</p>
<p>If you already have a dense k-nearest neighbor graph of sufficient
size, (e.g. at least 51 neighbors per point), you can use
<code>enn_to_lsnn</code> to convert it to a locally scaled nearest
neighbor graph of size <code>n_neighbors</code>, e.g.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lsnn15</span> <span class="op">&lt;-</span> <span class="fu">enn_to_lsnn</span><span class="op">(</span><span class="va">enn</span>, n_neighbors <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span></code></pre></div>
<p>You can then use it with UMAP like so:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">umap_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap2.html">umap2</a></span><span class="op">(</span><span class="va">data</span>, nn_method <span class="op">=</span> <span class="va">lsnn15</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">locally_scaled_knn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>,</span>
<span>                               <span class="va">n_neighbors</span> <span class="op">=</span> <span class="fl">15</span>,</span>
<span>                               <span class="va">n_extra</span> <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                               <span class="va">scale_from</span> <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                               <span class="va">scale_to</span> <span class="op">=</span> <span class="fl">7</span>,</span>
<span>                               <span class="va">n_threads</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                               <span class="va">nn_kind</span> <span class="op">=</span> <span class="st">"approx"</span>,</span>
<span>                               <span class="va">ret_knn</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                               <span class="va">verbose</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>  <span class="va">n_neighbors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">n_neighbors</span>, <span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">enn</span> <span class="op">&lt;-</span> <span class="fu">extended_knn</span><span class="op">(</span></span>
<span>    <span class="va">X</span>,</span>
<span>    <span class="va">n_neighbors</span>,</span>
<span>    n_extra <span class="op">=</span> <span class="va">n_extra</span>,</span>
<span>    n_threads <span class="op">=</span> <span class="va">n_threads</span>,</span>
<span>    nn_kind <span class="op">=</span> <span class="va">nn_kind</span>,</span>
<span>    verbose <span class="op">=</span> <span class="va">verbose</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">lsnn</span> <span class="op">&lt;-</span> <span class="fu">enn_to_lsnn</span><span class="op">(</span><span class="va">enn</span>, <span class="va">n_neighbors</span>, <span class="va">scale_from</span>, <span class="va">scale_to</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">ret_knn</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lsnn <span class="op">=</span> <span class="va">lsnn</span>, knn <span class="op">=</span> <span class="fu">truncate_graph</span><span class="op">(</span><span class="va">enn</span>, <span class="va">n_neighbors</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">lsnn</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">enn_to_lsnn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">enn</span>,</span>
<span>                        <span class="va">n_neighbors</span>,</span>
<span>                        <span class="va">scale_from</span> <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                        <span class="va">scale_to</span> <span class="op">=</span> <span class="fl">7</span>,</span>
<span>                        <span class="va">n_extra</span> <span class="op">=</span> <span class="fl">51</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">enn</span> <span class="op">&lt;-</span> <span class="fu">truncate_graph</span><span class="op">(</span><span class="va">enn</span>, <span class="va">n_neighbors</span> <span class="op">+</span> <span class="va">n_extra</span><span class="op">)</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">enn</span><span class="op">$</span><span class="va">idx</span><span class="op">)</span></span>
<span>  <span class="va">n_neighbors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">n_neighbors</span>, <span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">lsdist</span> <span class="op">&lt;-</span> <span class="fu">locally_scaled_distances</span><span class="op">(</span><span class="va">enn</span><span class="op">$</span><span class="va">idx</span>,</span>
<span>    <span class="va">enn</span><span class="op">$</span><span class="va">dist</span>,</span>
<span>    scale_from <span class="op">=</span> <span class="va">scale_from</span>,</span>
<span>    scale_to <span class="op">=</span> <span class="va">scale_to</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">enn_sorted</span> <span class="op">&lt;-</span> <span class="fu">sort_knn_graph</span><span class="op">(</span><span class="va">enn</span>, sort_values <span class="op">=</span> <span class="va">lsdist</span><span class="op">)</span></span>
<span>  <span class="va">lsnn</span> <span class="op">&lt;-</span> <span class="fu">truncate_graph</span><span class="op">(</span><span class="va">enn_sorted</span>, <span class="va">n_neighbors</span><span class="op">)</span></span>
<span>  <span class="va">lsnn</span> <span class="op">&lt;-</span> <span class="fu">sort_knn_graph</span><span class="op">(</span><span class="va">lsnn</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">lsnn</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">extended_knn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>,</span>
<span>                         <span class="va">n_neighbors</span> <span class="op">=</span> <span class="fl">150</span>,</span>
<span>                         <span class="va">n_extra</span> <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                         <span class="va">n_threads</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                         <span class="va">nn_kind</span> <span class="op">=</span> <span class="st">"approx"</span>,</span>
<span>                         <span class="va">verbose</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>  <span class="va">n_neighbors_extra</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">n_neighbors</span> <span class="op">+</span> <span class="va">n_extra</span>, <span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">n_neighbors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">n_neighbors</span>, <span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">nn_kind</span> <span class="op">==</span> <span class="st">"exact"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">knn</span> <span class="op">&lt;-</span> <span class="fu">rnndescent</span><span class="fu">::</span><span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/brute_force_knn.html" class="external-link">brute_force_knn</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">X</span>,</span>
<span>      k <span class="op">=</span> <span class="va">n_neighbors_extra</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>      n_threads <span class="op">=</span> <span class="va">n_threads</span>,</span>
<span>      verbose <span class="op">=</span> <span class="va">verbose</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">knn</span> <span class="op">&lt;-</span> <span class="fu">rnndescent</span><span class="fu">::</span><span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/rnnd_knn.html" class="external-link">rnnd_knn</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">X</span>,</span>
<span>      k <span class="op">=</span> <span class="va">n_neighbors_extra</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>      n_threads <span class="op">=</span> <span class="va">n_threads</span>,</span>
<span>      verbose <span class="op">=</span> <span class="va">verbose</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">knn</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Zelnik-Manor, Pietro Perona. Self-tuning spectral clustering. In NIPS, 2004.</span></span>
<span><span class="va">locally_scaled_distances</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">idx</span>,</span>
<span>                                     <span class="va">dist</span>,</span>
<span>                                     <span class="va">scale_from</span> <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                                     <span class="va">scale_to</span> <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">scale_to</span> <span class="op">&lt;</span> <span class="va">scale_from</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"scale_to must be greater than or equal to scale_from"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">idx</span><span class="op">)</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">dist</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"idx and dist must have the same number of columns"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">idx</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">scale_to</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"idx and dist must have at least scale_to columns"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">dist</span><span class="op">[</span>, <span class="va">scale_from</span><span class="op">:</span><span class="va">scale_to</span><span class="op">]</span><span class="op">)</span>, <span class="fl">1e-10</span><span class="op">)</span></span>
<span>  <span class="va">d2</span> <span class="op">&lt;-</span> <span class="va">dist</span> <span class="op">*</span> <span class="va">dist</span></span>
<span></span>
<span>  <span class="co"># scale by sigma_i</span></span>
<span>  <span class="va">d2_scaled_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep</a></span><span class="op">(</span><span class="va">d2</span>, <span class="fl">1</span>, <span class="va">sigma</span>, FUN <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># scale by sigma_j</span></span>
<span>  <span class="va">sigma_j</span> <span class="op">&lt;-</span> <span class="va">sigma</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span></span>
<span>  <span class="va">d2_scaled</span> <span class="op">&lt;-</span> <span class="va">d2_scaled_row</span> <span class="op">/</span> <span class="va">sigma_j</span></span>
<span></span>
<span>  <span class="va">d2_scaled</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># if enforce_self_first = TRUE then we ensure that the first column of the</span></span>
<span><span class="co"># returned graph is the self-neighbor, even if it ought to sort to a different</span></span>
<span><span class="co"># position. knn graphs usually assume that the first column is the</span></span>
<span><span class="co"># self-neighbor.</span></span>
<span><span class="va">sort_knn_graph</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">knn_graph</span>, <span class="va">sort_values</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">decreasing</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                           <span class="va">enforce_self_first</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dist_matrix</span> <span class="op">&lt;-</span> <span class="va">knn_graph</span><span class="op">$</span><span class="va">dist</span></span>
<span>  <span class="va">idx_matrix</span> <span class="op">&lt;-</span> <span class="va">knn_graph</span><span class="op">$</span><span class="va">idx</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">sort_values</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sort_values</span> <span class="op">&lt;-</span> <span class="va">dist_matrix</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">enforce_self_first</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dist_col1</span> <span class="op">&lt;-</span> <span class="va">dist_matrix</span><span class="op">[</span>, <span class="fl">1</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span>    <span class="va">idx_col1</span> <span class="op">&lt;-</span> <span class="va">idx_matrix</span><span class="op">[</span>, <span class="fl">1</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span></span>
<span>    <span class="va">idx_matrix</span> <span class="op">&lt;-</span> <span class="va">idx_matrix</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">dist_matrix</span> <span class="op">&lt;-</span> <span class="va">dist_matrix</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">sort_values</span> <span class="op">&lt;-</span> <span class="va">sort_values</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dist_matrix</span><span class="op">)</span></span>
<span>  <span class="va">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">dist_matrix</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">n</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">sort_values</span><span class="op">)</span> <span class="op">||</span> <span class="va">k</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">sort_values</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"dist_matrix and sort_values must have the same dimensions"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">sorted_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">n</span>, ncol <span class="op">=</span> <span class="va">k</span><span class="op">)</span></span>
<span>  <span class="va">sorted_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">n</span>, ncol <span class="op">=</span> <span class="va">k</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">sort_values</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span>, decreasing <span class="op">=</span> <span class="va">decreasing</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">sorted_dist</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">dist_matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">ord</span><span class="op">]</span></span>
<span>    <span class="va">sorted_idx</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">idx_matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">ord</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">enforce_self_first</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sorted_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">dist_col1</span>, <span class="va">sorted_dist</span><span class="op">)</span></span>
<span>    <span class="va">sorted_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">idx_col1</span>, <span class="va">sorted_idx</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>dist <span class="op">=</span> <span class="va">sorted_dist</span>, idx <span class="op">=</span> <span class="va">sorted_idx</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">truncate_graph</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">graph</span>, <span class="va">k</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">k</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">k</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">graph</span><span class="op">$</span><span class="va">idx</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"k is greater than the number of neighbors"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>idx <span class="op">=</span> <span class="va">graph</span><span class="op">$</span><span class="va">idx</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">]</span>, dist <span class="op">=</span> <span class="va">graph</span><span class="op">$</span><span class="va">dist</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="datasets">Datasets<a class="anchor" aria-label="anchor" href="#datasets"></a>
</h2>
<p>See the <a href="https://jlmelville.github.io/uwot/articles/umap-examples.html">examples
article</a>.</p>
</div>
<div class="section level2">
<h2 id="results">Results<a class="anchor" aria-label="anchor" href="#results"></a>
</h2>
<p>Let’s compare default UMAP (with <code>n_neighbors = 15</code>) to
LSNN with <code>n_neighbors = 15</code> picked from the 66-nearest
neighbors. As we are going to the effort of generating the 66-nearest
neighbors, let’s also see what UMAP with <code>n_neighbors = 66</code>
looks like.</p>
<p>UMAP results with <code>n_neighbors = 15</code> on the left
(<code>UMAP-15</code>), LSNN results are in the middle and UMAP with 66
neighbors (<code>UMAP-66</code>) is on the right. The number in
parentheses after the dataset name is the degree of overlap of the
15-nearest neighbors between the two methods (0 means no overlap, 1
means all neighbors are the same).</p>
<table class="table">
<colgroup>
<col width="35%">
<col width="21%">
<col width="21%">
<col width="21%">
</colgroup>
<thead><tr class="header">
<th align="center">Dataset</th>
<th>UMAP-15</th>
<th>LSNN</th>
<th>UMAP-66</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">mammoth (0.90)</td>
<td><img src="img/lsnn/umap/mammoth.png" alt="mammoth-umap"></td>
<td><img src="img/lsnn/lsnn/mammoth.png" alt="mammoth-lsnn"></td>
<td><img src="img/lsnn/umap66/mammoth.png" alt="mammoth-umap66"></td>
</tr>
<tr class="even">
<td align="center">scurvehole (0.92)</td>
<td><img src="img/lsnn/umap/scurvehole.png" alt="scurvehole-umap"></td>
<td><img src="img/lsnn/lsnn/scurvehole.png" alt="scurvehole-lsnn"></td>
<td><img src="img/lsnn/umap66/scurvehole.png" alt="scurvehole-umap66"></td>
</tr>
<tr class="odd">
<td align="center">isoswiss (0.92)</td>
<td><img src="img/lsnn/umap/isoswiss.png" alt="isoswiss-umap"></td>
<td><img src="img/lsnn/lsnn/isoswiss.png" alt="isoswiss-lsnn"></td>
<td><img src="img/lsnn/umap66/isoswiss.png" alt="isoswiss-umap66"></td>
</tr>
<tr class="even">
<td align="center">hierarchical (0.76)</td>
<td><img src="img/lsnn/umap/hierarchical.png" alt="hierarchical-umap"></td>
<td><img src="img/lsnn/lsnn/hierarchical.png" alt="hierarchical-lsnn"></td>
<td><img src="img/lsnn/umap66/hierarchical.png" alt="hierarchical-umap66"></td>
</tr>
<tr class="odd">
<td align="center">spheres (0.84)</td>
<td><img src="img/lsnn/umap/spheres.png" alt="spheres-umap"></td>
<td><img src="img/lsnn/lsnn/spheres.png" alt="spheres-lsnn"></td>
<td><img src="img/lsnn/umap66/spheres.png" alt="spheres-umap66"></td>
</tr>
<tr class="even">
<td align="center">coil20 (0.84)</td>
<td><img src="img/lsnn/umap/coil20.png" alt="coil20-umap"></td>
<td><img src="img/lsnn/lsnn/coil20.png" alt="coil20-lsnn"></td>
<td><img src="img/lsnn/umap66/coil20.png" alt="coil20-umap66"></td>
</tr>
<tr class="odd">
<td align="center">coil100 (0.85)</td>
<td><img src="img/lsnn/umap/coil100.png" alt="coil100-umap"></td>
<td><img src="img/lsnn/lsnn/coil100.png" alt="coil100-lsnn"></td>
<td><img src="img/lsnn/umap66/coil100.png" alt="coil100-umap66"></td>
</tr>
<tr class="even">
<td align="center">macosko2015 (0.40)</td>
<td><img src="img/lsnn/umap/macosko2015.png" alt="macosko2015-umap"></td>
<td><img src="img/lsnn/lsnn/macosko2015.png" alt="macosko2015-lsnn"></td>
<td><img src="img/lsnn/umap66/macosko2015.png" alt="macosko2015-umap66"></td>
</tr>
<tr class="odd">
<td align="center">macosko2015pca100 (0.66)</td>
<td><img src="img/lsnn/umap/macosko2015pca100.png" alt="macosko2015pca100-umap"></td>
<td><img src="img/lsnn/lsnn/macosko2015pca100.png" alt="macosko2015pca100-lsnn"></td>
<td><img src="img/lsnn/umap66/macosko2015pca100.png" alt="macosko2015pca100-umap66"></td>
</tr>
<tr class="even">
<td align="center">mnist (0.76)</td>
<td><img src="img/lsnn/umap/mnist.png" alt="mnist-umap"></td>
<td><img src="img/lsnn/lsnn/mnist.png" alt="mnist-lsnn"></td>
<td><img src="img/lsnn/umap66/mnist.png" alt="mnist-umap66"></td>
</tr>
<tr class="odd">
<td align="center">fashion (0.69)</td>
<td><img src="img/lsnn/umap/fashion.png" alt="fashion-umap"></td>
<td><img src="img/lsnn/lsnn/fashion.png" alt="fashion-lsnn"></td>
<td><img src="img/lsnn/umap66/fashion.png" alt="fashion-umap66"></td>
</tr>
<tr class="even">
<td align="center">norb (0.78)</td>
<td><img src="img/lsnn/umap/norb.png" alt="norb-umap"></td>
<td><img src="img/lsnn/lsnn/norb.png" alt="norb-lsnn"></td>
<td><img src="img/lsnn/umap66/norb.png" alt="norb-umap66"></td>
</tr>
<tr class="odd">
<td align="center">ng20 (0.67)</td>
<td><img src="img/lsnn/umap/ng20.png" alt="ng20-umap"></td>
<td><img src="img/lsnn/lsnn/ng20.png" alt="ng20-lsnn"></td>
<td><img src="img/lsnn/umap66/ng20.png" alt="ng20-umap66"></td>
</tr>
</tbody>
</table>
<p>The average overlap is in the 77-78% range. Clearly, low-dimensional
datasets show the smallest difference in overlap, but higher
dimensionality doesn’t necessarily mean the lowest overlap:
<code>coil100</code> has nearly 50,000 features, but has quite a high
overlap (0.84). <code>macosko2015</code> (with 3,000 features) has an
anomalously low overlap at 0.40. Applying PCA to reduce the
dimensionality to 100 brings the overlap up to 0.66.</p>
<p>For all that, I don’t see a huge difference between the two results.
The clusters in <code>mnist</code>, <code>fashion</code> and
<code>macosko2015pca100</code> are moved about a bit but not in a way
that would be the source of any revelations. Maybe the
<code>mammoth</code> and <code>scurvehole</code> results are a bit
better with LSNN?</p>
<p><code>fashion</code> and <code>ng20</code> have some outliers which
compresses the main body of the embedding into the center of the plot a
bit.</p>
<p>There are some intriguing signs in <code>norb</code> of better
clustering. I suspect this is related to the fact that
<code>n_neighbors = 15</code> is probably a bit too low for this dataset
(see the <a href="https://jlmelville.github.io/uwot/articles/mutual-nearest-neighbors.html#norb-revisited">norb
revisited section</a> of the mutual nearest neighbors article for more).
The <code>UMAP-66</code> results look the best here.</p>
<p><code>macosko2015</code> might also have something going on. The
smaller clusters are a bit more separated from the big cyan blob. The
effect is definitely much larger compared to the PCA-reduced version.
And the result is distinct from the <code>UMAP-66</code> result.</p>
<p>Would you better off using <code>n_neighbors = 66</code> for
everything? For some datasets it looks better (<code>mammoth</code>,
<code>scurvehole</code>, <code>isoswiss</code> a little bit,
<code>norb</code> as previously mentioned), but for <code>coil20</code>
and <code>coil100</code> it looks worse, with less of the images being
separated into their circular clusters. For everything else, it’s pretty
much the same result as with <code>n_neighbors = 15</code>.</p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>For UMAP at least, it doesn’t seem like using the locally-scaled
neighbors makes enough of a difference that it’s worth the extra
computation.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James Melville.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>

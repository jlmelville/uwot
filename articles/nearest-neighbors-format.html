<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Nearest Neighbor Format • uwot</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Nearest Neighbor Format">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">uwot</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.2.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/uwot.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jlmelville/uwot/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Nearest Neighbor Format</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jlmelville/uwot/blob/master/vignettes/articles/nearest-neighbors-format.Rmd" class="external-link"><code>vignettes/articles/nearest-neighbors-format.Rmd</code></a></small>
      <div class="d-none name"><code>nearest-neighbors-format.Rmd</code></div>
    </div>

    
    
<p>The Python implementation of UMAP supports lots of distance metrics;
<code>uwot</code> does not, because it depends on the distance metrics
supported by <code>RcppAnnoy</code>, which in turn depends on those
supported by <code>Annoy</code>. For more flexibility, at the cost of
convenience, you can generate nearest neighbor data for <code>X</code>
by some other means and pass that to <code>umap</code> (or
<code>tumap</code> or <code>lvish</code>) directly via the
<code>nn_method</code> parameter.</p>
<div class="section level2">
<h2 id="nearest-neighbor-graph-format">Nearest Neighbor Graph Format<a class="anchor" aria-label="anchor" href="#nearest-neighbor-graph-format"></a>
</h2>
<p>The format expected by <code>nn_method</code> is a <code>list</code>
containing the following two entries:</p>
<ul>
<li>
<code>idx</code>: a matrix of dimension
<code>n_vertices x n_neighbors</code>, where each row contains the
indexes (starting at <code>1</code>) of the nearest neighbors of each
item (vertex) in the dataset. Each item is always the nearest neighbor
of itself, so the first element in row <code>i</code> should always be
<code>i</code>. If it isn’t then either you are using a really weird
non-metric distance or your approximate nearest neighbor method is
returning way too approximate results. In either case, you should expect
bad results.</li>
<li>
<code>dist</code>: a matrix of dimension
<code>n_vertices x n_neighbors</code>, where each row contains the
distances of the nearest neighbors of each item (vertex) in the dataset,
in Each item is always the nearest neighbor of itself, so the first
element in row <code>i</code> should always be <code>0.0</code>.</li>
</ul>
</div>
<div class="section level2">
<h2 id="sparse-distance-matrix-format">Sparse Distance Matrix Format<a class="anchor" aria-label="anchor" href="#sparse-distance-matrix-format"></a>
</h2>
<p>Alternatively, you can pass a sparse distance matrix where:</p>
<ul>
<li>the format should be <code>dgCMatrix</code> (the typical sparse
matrix format).</li>
<li>non-zero entries are the distances.</li>
<li>dimensions are of <code>n_vertices x n_vertices</code> for
<code>umap</code> and <code>n_model_vertices x n_vertices</code> for
<code>umap_transform</code>
<ul>
<li>to put it another way: the neighbor distances should be arranged so
that the non-zero entries in the <code>i</code>th column of the matrix
contains the distances between observation <code>i</code> and its
nearest neighbors.</li>
</ul>
</li>
<li>An advantage of using a sparse distance matrix: you are not
restricted to a fixed value of <code>n_neighbors</code> for each
observation. Each column can contain a different number of non-zero
distances. See the paper by <a href="https://arxiv.org/abs/2108.05525" class="external-link">Dalmia and Sia</a> for why you
might want to do this. The graph edge weight calculation will be
adjusted to account for the different number of neighbors of each
observation. There must be at least one neighbor for each
observation.</li>
<li>Explicit zero distances will be removed from the matrix. This is in
contrast to the use of the nearest neighbor list matrix format where
typically the zero distance between an observation and itself is found
as part of the nearest neighbor search routine. The sparse distance
matrix approach will account for the zero self-distance being implicit.
To keep explicit zero distances between other observations set them to a
small but non-zero value, e.g. <code>1e-10</code>.</li>
<li>A slight disadvantage with using a distance matrix is that the
distances need to be sorted.</li>
<li>Sparse distance matrix input is not currently supported for the
<code>lvish</code> method.</li>
</ul>
<p>If you use pre-computed nearest neighbor data, be aware that:</p>
<ul>
<li>You can’t use pre-computed nearest neighbor data and also use
<code>metric</code>.</li>
<li>You can explicitly set <code>X</code> to NULL, as long as you don’t
try and use an initialization method that makes use of <code>X</code>
(<code>init = "pca"</code> or <code>init = "spca"</code>).</li>
<li>You <em>can</em> transform new data by setting
<code>ret_model = TRUE</code>. You must provide
<code>umap_transform</code> with the distances between new data and the
original data via its <code>nn_method</code> parameter.</li>
</ul>
<p>Here’s an example of using pre-computed nearest neighbor data using
the even-numbered observations in <code>iris</code> to build an initial
model and then transforming the odd-numbered observations. This relies
on some internal <code>uwot</code> functions which I do not promise have
a stable API (i.e. this may example may be broken when you read this),
but it gives you the general idea:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_even</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">iris_odd</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">iris_even_nn</span> <span class="op">&lt;-</span> <span class="fu">uwot</span><span class="fu">:::</span><span class="fu">annoy_nn</span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="fu">uwot</span><span class="fu">:::</span><span class="fu">x2m</span><span class="op">(</span><span class="va">iris_even</span><span class="op">)</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">15</span>,</span>
<span>  metric <span class="op">=</span> <span class="st">"euclidean"</span>,</span>
<span>  ret_index <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">iris_odd_nn</span> <span class="op">&lt;-</span> <span class="fu">annoy_search</span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="fu">uwot</span><span class="fu">:::</span><span class="fu">x2m</span><span class="op">(</span><span class="va">iris_odd</span><span class="op">)</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">15</span>,</span>
<span>  ann <span class="op">=</span> <span class="va">iris_even_nn</span><span class="op">$</span><span class="va">index</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Delete the Annoy index, force the transform method to use the nn distances </span></span>
<span><span class="co"># directly</span></span>
<span><span class="va">iris_even_nn</span><span class="op">$</span><span class="va">index</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="va">iris_even_umap</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    nn_method <span class="op">=</span> <span class="va">iris_even_nn</span>,</span>
<span>    ret_model <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">iris_odd_transform</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/umap_transform.html">umap_transform</a></span><span class="op">(</span>X <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">iris_even_umap</span>, nn_method <span class="op">=</span> <span class="va">iris_odd_nn</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exporting-nearest-neighbor-data-from-uwot">Exporting nearest neighbor data from <code>uwot</code><a class="anchor" aria-label="anchor" href="#exporting-nearest-neighbor-data-from-uwot"></a>
</h2>
<p>If you set <code>ret_nn = TRUE</code>, the return value of
<code>umap</code> will be a list, and the <code>nn</code> item contains
the nearest neighbor data in a format that can be used with
<code>nn_method</code>. This is handy if you are going to be running
UMAP multiple times with the same data and <code>n_neighbors</code> and
<code>scale</code> settings, because the nearest neighbor calculation
can be the most time-consuming part of the calculation.</p>
<p>Normally the contents of <code>nn</code> is itself a list, the value
of which is the nearest neighbor data. The name is the type of metric
that generated the data. As an example, here’s what the first few items
of the <code>iris</code> 5-NN data should look like:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">lapply</span>(<span class="fu">umap</span>(iris, <span class="at">ret_nn =</span> <span class="cn">TRUE</span>, <span class="at">n_neighbors =</span> <span class="dv">5</span>)<span class="sc">$</span>nn<span class="sc">$</span>euclidean, head)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="sc">$</span><span class="st">`</span><span class="at">idx</span><span class="st">`</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>     [,<span class="dv">1</span>] [,<span class="dv">2</span>] [,<span class="dv">3</span>] [,<span class="dv">4</span>] [,<span class="dv">5</span>]</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>[<span class="dv">1</span>,]    <span class="dv">1</span>   <span class="dv">18</span>    <span class="dv">5</span>   <span class="dv">40</span>   <span class="dv">29</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>[<span class="dv">2</span>,]    <span class="dv">2</span>   <span class="dv">35</span>   <span class="dv">46</span>   <span class="dv">13</span>   <span class="dv">10</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>[<span class="dv">3</span>,]    <span class="dv">3</span>   <span class="dv">48</span>    <span class="dv">4</span>    <span class="dv">7</span>   <span class="dv">13</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>[<span class="dv">4</span>,]    <span class="dv">4</span>   <span class="dv">48</span>   <span class="dv">30</span>   <span class="dv">31</span>    <span class="dv">3</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>[<span class="dv">5</span>,]    <span class="dv">5</span>   <span class="dv">38</span>    <span class="dv">1</span>   <span class="dv">18</span>   <span class="dv">41</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>[<span class="dv">6</span>,]    <span class="dv">6</span>   <span class="dv">19</span>   <span class="dv">11</span>   <span class="dv">49</span>   <span class="dv">45</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="sc">$</span>dist</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>     [,<span class="dv">1</span>]      [,<span class="dv">2</span>]      [,<span class="dv">3</span>]      [,<span class="dv">4</span>]      [,<span class="dv">5</span>]</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>[<span class="dv">1</span>,]    <span class="dv">0</span> <span class="fl">0.1000000</span> <span class="fl">0.1414214</span> <span class="fl">0.1414214</span> <span class="fl">0.1414214</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>[<span class="dv">2</span>,]    <span class="dv">0</span> <span class="fl">0.1414214</span> <span class="fl">0.1414214</span> <span class="fl">0.1414214</span> <span class="fl">0.1732051</span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>[<span class="dv">3</span>,]    <span class="dv">0</span> <span class="fl">0.1414214</span> <span class="fl">0.2449490</span> <span class="fl">0.2645751</span> <span class="fl">0.2645751</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>[<span class="dv">4</span>,]    <span class="dv">0</span> <span class="fl">0.1414214</span> <span class="fl">0.1732051</span> <span class="fl">0.2236068</span> <span class="fl">0.2449490</span></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>[<span class="dv">5</span>,]    <span class="dv">0</span> <span class="fl">0.1414214</span> <span class="fl">0.1414214</span> <span class="fl">0.1732051</span> <span class="fl">0.1732051</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>[<span class="dv">6</span>,]    <span class="dv">0</span> <span class="fl">0.3316625</span> <span class="fl">0.3464102</span> <span class="fl">0.3605551</span> <span class="fl">0.3741657</span></span></code></pre></div>
<p>If for some reason you specify <code>ret_nn</code> while supplying
precomputed nearest neighbor data to <code>nn_method</code>, the
returned data should be identical to what you passed in, and the list
item names will be <code>precomputed</code>.</p>
</div>
<div class="section level2">
<h2 id="multiple-neighbor-data">Multiple neighbor data<a class="anchor" aria-label="anchor" href="#multiple-neighbor-data"></a>
</h2>
<p>As discussed under the <a href="https://jlmelville.github.io/uwot/articles/mixed-data-types.html">Mixed
Data Types</a> article, you can apply multiple distance metrics to
different parts of matrix or data frame input data. if you do this, then
<code>ret_nn</code> will return all the neighbor data. The list under
<code>nn</code> will now contain as many items as metrics, in the order
they were specified. For instance, if the <code>metric</code> argument
is:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">metric</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"euclidean"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Petal.Width"</span>, <span class="st">"Petal.Length"</span><span class="op">)</span>,</span>
<span>              <span class="st">"cosine"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sepal.Width"</span>, <span class="st">"Sepal.Length"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The <code>nn</code> list will contain two list entries. The first
will be called <code>euclidean</code> and the second
<code>cosine</code>.</p>
<p>If you have access to multiple distance metrics, you may also provide
multiple precomputed neighbor data to <code>nn_method</code> in the same
format: a list of lists, where each sublist has the same format as
described above (i.e. the two matrices, <code>idx</code> and
<code>dist</code>). The names of the list items are ignored, so you
don’t need to set them. Roughly, do something like this:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nn_metric1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>idx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>, dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nn_metric2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>idx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>, dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">umap_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span>nn_method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">nn_metric1</span>, <span class="va">nn_metric2</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
<p>The different neighbor data must all have the same number of
neighbors, i.e. the number of columns in all the matrices must be the
same.</p>
</div>
<div class="section level2">
<h2 id="numeric-y">Numeric <code>y</code><a class="anchor" aria-label="anchor" href="#numeric-y"></a>
</h2>
<p>If you are using supervised UMAP with a numeric <code>y</code>, then
you can also pass nearest neighbor data to <code>y</code>, using the
same format as above. In this case the nearest neighbors should be with
respect to the data in <code>y</code>.</p>
<p>Note that you <em>cannot</em> pass categorical <code>y</code> as
nearest neighbor data. This is because the processing of the data goes
through a different code path that doesn’t directly calculate nearest
neighbors: if <code>y</code> is a factor, when there are only a small
number of levels, the number of neighbors of an item can be vastly
larger than <code>n_neighbors</code>.</p>
<p>Nearest neighbor data for <code>y</code> is not returned from
<code>umap</code> for re-use.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James Melville.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>

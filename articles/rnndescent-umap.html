<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="uwot">
<title>Using rnndescent for nearest neighbors • uwot</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using rnndescent for nearest neighbors">
<meta property="og:description" content="uwot">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">uwot</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.16.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/uwot.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/jlmelville/uwot/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using rnndescent for nearest neighbors</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jlmelville/uwot/blob/HEAD/vignettes/articles/rnndescent-umap.Rmd" class="external-link"><code>vignettes/articles/rnndescent-umap.Rmd</code></a></small>
      <div class="d-none name"><code>rnndescent-umap.Rmd</code></div>
    </div>

    
    
<p>This is a companion article to the <a href="https://jlmelville.github.io/uwot/articles/hnsw-umap.html">HNSW
article</a> about how to use nearest neighbor data from other packages
with <code>uwot</code>. You should read that article as well as the on
<code>uwot</code>’s <a href="https://jlmelville.github.io/uwot/articles/nearest-neighbors-format.html">nearest
neighbor format</a> for proper details. I’m going to provide minimal
commentary here.</p>
<p>The <a href="https://cran.r-project.org/package=rnndescent" class="external-link">rnndescent</a>
package can be used as an alternative to the internal Annoy-based
nearest neighbor method used by <code>uwot</code>. It is based on the
Python package <a href="https://github.com/lmcinnes/pynndescent" class="external-link">PyNNDescent</a> and
offers a wider range of metrics than other packages and the ability to
work with sparse data. For an example of using <code>rnndescent</code>
with sparse data see the <a href="https://jlmelville.github.io/uwot/articles/sparse-data-example.html">sparse
UMAP article</a>. Here we will use typical dense data and the typical
Euclidean distance.</p>
<p>First we need some data, which I will install via the
<code>snedata</code> package from GitHub:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("pak")</span></span>
<span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pkg_install.html" class="external-link">pkg_install</a></span><span class="op">(</span><span class="st">"jlmelville/snedata"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># or</span></span>
<span><span class="co"># install.packages("devtools")</span></span>
<span><span class="co"># devtools::install_github("jlmelville/snedata")</span></span></code></pre></div>
<p>The HNSW article used the MNIST digits data, but to mix things up a
bit I’ll use the <a href="https://github.com/zalandoresearch/fashion-mnist" class="external-link">Fashion MNIST
data</a>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion</span> <span class="op">&lt;-</span> <span class="fu">snedata</span><span class="fu">::</span><span class="fu">download_fashion_mnist</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fashion_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fashion</span>, <span class="fl">60000</span><span class="op">)</span></span>
<span><span class="va">fashion_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">fashion</span>, <span class="fl">10000</span><span class="op">)</span></span></code></pre></div>
<p>This is structured just like the MNIST digits, but it uses images of
10 different classes of fashion items (e.g. trousers, dress, bag). The
name of the item is in the <code>Description</code> column.</p>
<div class="section level2">
<h2 id="using-rnndescent">Using rnndescent<a class="anchor" aria-label="anchor" href="#using-rnndescent"></a>
</h2>
<p>Now install <code>rnndescent</code> from CRAN:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"rnndescent"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jlmelville.github.io/rnndescent/" class="external-link">rnndescent</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="build-an-index-for-the-training-data">Build an index for the training data<a class="anchor" aria-label="anchor" href="#build-an-index-for-the-training-data"></a>
</h3>
<p>First, we will build a search index using the training data. You
should use as many threads (<code>n_threads</code>) as you feel
comfortable with. You can also set <code>verbose = TRUE</code>, but when
building an index you will see a lot of output so I won’t reproduce that
here. The <code>k</code> parameter is the number of nearest neighbors
that we are looking for. The index is tuned to work well for that number
of neighbors. The <code>metric</code> parameter is the distance metric
to use, but the default is Euclidean, so we don’t need to specify that.
Finally, there is a stochastic aspect to the index building. You may get
slightly different results from me, but I am leaving the seed unset so
that we must both live with the inherently random nature of the index
building process.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/rnnd_build.html" class="external-link">rnnd_build</a></span><span class="op">(</span><span class="va">fashion_train</span>, k <span class="op">=</span> <span class="fl">15</span>, n_threads <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<p>What’s in the returned index? A bunch of stuff:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fashion_index</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"graph"</span>           <span class="st">"prep"</span>            <span class="st">"data"</span>            <span class="st">"original_metric"</span> <span class="st">"use_alt_metric"</span>  <span class="st">"search_forest"</span>   <span class="st">"search_graph"</span></span></code></pre></div>
<p>Most of that is there to support searching the index. What we want is
the <code>graph</code>. This is a list with two elements,
<code>idx</code> and <code>dist</code>, which contain the nearest
neighbor indices and distances respectively. The nearest neighbor of
each item is itself, so we expect the first column of <code>idx</code>
to be the sequence 1, 2, 3, … and the first column of <code>dist</code>
to be all zeros.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_index</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">idx</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>     [,<span class="dv">1</span>]  [,<span class="dv">2</span>]  [,<span class="dv">3</span>]</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>[<span class="dv">1</span>,]    <span class="dv">1</span> <span class="dv">25720</span> <span class="dv">27656</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>[<span class="dv">2</span>,]    <span class="dv">2</span> <span class="dv">42565</span> <span class="dv">37551</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>[<span class="dv">3</span>,]    <span class="dv">3</span> <span class="dv">53514</span> <span class="dv">35425</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_index</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">dist</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>     [,<span class="dv">1</span>]      [,<span class="dv">2</span>]      [,<span class="dv">3</span>]</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>[<span class="dv">1</span>,]    <span class="dv">0</span> <span class="fl">1188.7826</span> <span class="fl">1215.3440</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>[<span class="dv">2</span>,]    <span class="dv">0</span> <span class="fl">1048.0482</span> <span class="fl">1068.3951</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>[<span class="dv">3</span>,]    <span class="dv">0</span>  <span class="fl">532.6199</span>  <span class="fl">632.1653</span></span></code></pre></div>
<p>With other nearest neighbor methods like HNSW and Annoy, you would
have to run a separate query step to get the k-nearest neighbors for the
data used to build the index. One of the advantages of
<code>rnndescent</code> is that you can get this data directly from the
index without the separate query step. Note that you can still query the
index if you want to, and those results might be a bit more accurate,
but I am quietly confident that the results from the index are
sufficient for UMAP.</p>
</div>
<div class="section level3">
<h3 id="query-the-test-data">Query the test data<a class="anchor" aria-label="anchor" href="#query-the-test-data"></a>
</h3>
<p>To get the test set neighbors, query the index with the test
data:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_test_query_neighbors</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/rnnd_query.html" class="external-link">rnnd_query</a></span><span class="op">(</span></span>
<span>    index <span class="op">=</span> <span class="va">fashion_index</span>,</span>
<span>    query <span class="op">=</span> <span class="va">fashion_test</span>,</span>
<span>    k <span class="op">=</span> <span class="fl">15</span>,</span>
<span>    n_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_test_query_neighbors</span><span class="op">$</span><span class="va">idx</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>      [,<span class="dv">1</span>]  [,<span class="dv">2</span>]  [,<span class="dv">3</span>]</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>[<span class="dv">1</span>,] <span class="dv">18095</span> <span class="dv">53940</span> <span class="dv">18353</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>[<span class="dv">2</span>,]  <span class="dv">8573</span> <span class="dv">31349</span>  <span class="dv">3885</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>[<span class="dv">3</span>,]   <span class="dv">286</span> <span class="dv">38144</span>  <span class="dv">3422</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_test_query_neighbors</span><span class="op">$</span><span class="va">dist</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>          [,<span class="dv">1</span>]      [,<span class="dv">2</span>]      [,<span class="dv">3</span>]</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>[<span class="dv">1</span>,]  <span class="fl">482.2966</span>  <span class="fl">681.9905</span>  <span class="fl">708.4991</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>[<span class="dv">2</span>,] <span class="fl">1308.0019</span> <span class="fl">1329.3134</span> <span class="fl">1382.7317</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>[<span class="dv">3</span>,]  <span class="fl">466.0322</span>  <span class="fl">538.5378</span>  <span class="fl">555.8795</span></span></code></pre></div>
<p>As we are querying the test data against the training data, the
nearest neighbor of any test item is <em>not</em> the test item
itself.</p>
<p>We now have all the nearest neighbor data we need. The good news is
that it’s already in a format that <code>uwot</code> can use so we can
proceed straight to running UMAP.</p>
</div>
</div>
<div class="section level2">
<h2 id="using-rnndescent-nearest-neighbors-with-umap">Using rnndescent nearest neighbors with UMAP<a class="anchor" aria-label="anchor" href="#using-rnndescent-nearest-neighbors-with-umap"></a>
</h2>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jlmelville/uwot" class="external-link">uwot</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="umap-on-training-data">UMAP on training data<a class="anchor" aria-label="anchor" href="#umap-on-training-data"></a>
</h3>
<p>To use pre-computed nearest neighbor data with <code>uwot</code> pass
it as the <code>nn_method</code> parameter. In this case, that is the
<code>graph</code> item in <code>fashion_index</code>. See the HSNW
article for more details on the other parameters, but this is designed
to give pretty typical UMAP results.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_train_umap</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    nn_method <span class="op">=</span> <span class="va">fashion_index</span><span class="op">$</span><span class="va">graph</span>,</span>
<span>    batch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    n_epochs <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    n_sgd_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    ret_model <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>UMAP embedding parameters a <span class="ot">=</span> <span class="fl">1.896</span> b <span class="ot">=</span> <span class="fl">0.8006</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>Commencing smooth kNN distance calibration using <span class="dv">6</span> threads with target n_neighbors <span class="ot">=</span> <span class="dv">15</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>Initializing from normalized Laplacian <span class="sc">+</span> <span class="fu">noise</span> (using irlba)</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>Commencing optimization <span class="cf">for</span> <span class="dv">500</span> epochs, with <span class="dv">1359454</span> positive edges using <span class="dv">6</span> threads</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>Using method <span class="st">'umap'</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>Optimizing with Adam alpha <span class="ot">=</span> <span class="dv">1</span> beta1 <span class="ot">=</span> <span class="fl">0.5</span> beta2 <span class="ot">=</span> <span class="fl">0.9</span> eps <span class="ot">=</span> <span class="fl">1e-07</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="dv">0</span><span class="sc">%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>[<span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="er">**************************************************|</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>Optimization finished</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>Note<span class="sc">:</span> model requested with precomputed neighbors. For transforming new data, distance data must be provided separately</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="transforming-test-data">Transforming test data<a class="anchor" aria-label="anchor" href="#transforming-test-data"></a>
</h3>
<p>Now we have a UMAP model we can transform the test set data. Once
again we don’t need to pass in any test set data except the neighbors as
<code>nn_method</code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_test_umap</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/umap_transform.html">umap_transform</a></span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    model <span class="op">=</span> <span class="va">fashion_train_umap</span>,</span>
<span>    nn_method <span class="op">=</span> <span class="va">fashion_test_query_neighbors</span>,</span>
<span>    n_sgd_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>Read <span class="dv">10000</span> rows</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>Processing block <span class="dv">1</span> of <span class="dv">1</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>Commencing smooth kNN distance calibration using <span class="dv">6</span> threads with target n_neighbors <span class="ot">=</span> <span class="dv">15</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>Initializing by weighted average of neighbor coordinates using <span class="dv">6</span> threads</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>Commencing optimization <span class="cf">for</span> <span class="dv">167</span> epochs, with <span class="dv">150000</span> positive edges using <span class="dv">6</span> threads</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>Using method <span class="st">'umap'</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>Optimizing with Adam alpha <span class="ot">=</span> <span class="dv">1</span> beta1 <span class="ot">=</span> <span class="fl">0.5</span> beta2 <span class="ot">=</span> <span class="fl">0.9</span> eps <span class="ot">=</span> <span class="fl">1e-07</span></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a><span class="dv">0</span><span class="sc">%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>[<span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="er">**************************************************|</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>Finished</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="plotting-the-results">Plotting the results<a class="anchor" aria-label="anchor" href="#plotting-the-results"></a>
</h3>
<p>Now to take a look at the results, using <code>ggplot2</code> for
plotting, and <code>Polychrome</code> for a suitable categorical
palette.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ggplot2"</span>, <span class="st">"Polychrome"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://oompa.r-forge.r-project.org/" class="external-link">Polychrome</a></span><span class="op">)</span></span></code></pre></div>
<p>The following code creates a palette of 10 (hopefully) visually
distinct colors which will map each point to the type of fashion item it
represents. This is found in the <code>Description</code> factor column
of the original data.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">palette</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu">Polychrome</span><span class="fu">::</span><span class="fu">createPalette</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">fashion</span><span class="op">$</span><span class="va">Description</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span>,</span>
<span>  seedcolors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#ffffff"</span>, <span class="st">"#000000"</span><span class="op">)</span>,</span>
<span>  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">90</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>And here are the results:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">fashion_train_umap</span><span class="op">$</span><span class="va">embedding</span>, Description <span class="op">=</span> <span class="va">fashion_train</span><span class="op">$</span><span class="va">Description</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X1</span>, y <span class="op">=</span> <span class="va">X2</span>, color <span class="op">=</span> <span class="va">Description</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.1</span>, size <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">palette</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Fashion MNIST training set UMAP"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">""</span>,</span>
<span>    y <span class="op">=</span> <span class="st">""</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Description"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">fashion_test_umap</span>, Description <span class="op">=</span> <span class="va">fashion_test</span><span class="op">$</span><span class="va">Description</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X1</span>, y <span class="op">=</span> <span class="va">X2</span>, color <span class="op">=</span> <span class="va">Description</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.4</span>, size <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">palette</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Fashion MNIST test set UMAP"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">""</span>,</span>
<span>    y <span class="op">=</span> <span class="st">""</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Description"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="img/rnndescent-umap/fashion-train.png" alt="Fashion training data"><img src="img/rnndescent-umap/fashion-test.png" alt="Fashion test set"></p>
<p>These results are typical for Fashion MNIST result with UMAP. For
example, see the first image in <a href="https://umap-learn.readthedocs.io/en/latest/supervised.html#umap-on-fashion-mnist" class="external-link">part
of the Python UMAP documentation</a>. So it looks like
<code>rnndescent</code> with its default settings does a good job with
this dataset.</p>
</div>
<div class="section level3">
<h3 id="a-potentially-simpler-workflow">A potentially simpler workflow<a class="anchor" aria-label="anchor" href="#a-potentially-simpler-workflow"></a>
</h3>
<p>If you don’t want to transform new data, you can make life a bit
easier. Instead of <code>rnnd_build</code>, use <code>rnnd_knn</code>
which behaves a lot like <code>rnnd_build</code> but doesn’t preserve
the index or do any index preparation. This saves time and the nearest
neighbor results are returned directly in the return result. Let’s use
the full Fashion MNIST results as an example:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_knn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/rnnd_knn.html" class="external-link">rnnd_knn</a></span><span class="op">(</span><span class="va">fashion</span>, k <span class="op">=</span> <span class="fl">15</span>, n_threads <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fashion_knn</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"idx"</span>  <span class="st">"dist"</span></span></code></pre></div>
<p>You can then pass <code>fashion_knn</code> to
<code>nn_method</code>:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_umap</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    nn_method <span class="op">=</span> <span class="va">fashion_knn</span>,</span>
<span>    batch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    n_epochs <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    n_sgd_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>(I have spared you the log output). We don’t need to pass
<code>ret_model = TRUE</code> here because we can’t transform new data.
Here is the UMAP plot for the full Fashion MNIST dataset:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">fashion_umap</span>, Description <span class="op">=</span> <span class="va">fashion</span><span class="op">$</span><span class="va">Description</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X1</span>, y <span class="op">=</span> <span class="va">X2</span>, color <span class="op">=</span> <span class="va">Description</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.1</span>, size <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">palette</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Fashion MNIST UMAP"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">""</span>,</span>
<span>    y <span class="op">=</span> <span class="st">""</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Description"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="img/rnndescent-umap/fashion-umap.png" alt="fashion UMAP"><div class="figcaption">fashion UMAP</div>
</div>
<p>Everything looks as expected. However, if you think you might want to
transform new data in the future, then you will need to completely
restart the process, with <code>rnnd_build</code> and using
<code>ret_model = TRUE</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusions">Conclusions<a class="anchor" aria-label="anchor" href="#conclusions"></a>
</h2>
<p>If you want to use <code>rnndescent</code> with <code>uwot</code>,
then:</p>
<ul>
<li>Run <code><a href="https://jlmelville.github.io/rnndescent/reference/rnnd_build.html" class="external-link">rnndescent::rnnd_build</a></code> on your training data.</li>
<li>Run <code><a href="../reference/umap.html">uwot::umap</a></code> with <code>nn_method</code> set to the
<code>graph</code> item in the result of <code>rnnd_build</code> and
remember to set <code>ret_model = TRUE</code>.</li>
</ul>
<p>To transform new data:</p>
<ul>
<li>Run <code><a href="https://jlmelville.github.io/rnndescent/reference/rnnd_query.html" class="external-link">rnndescent::rnnd_query</a></code> on your test data, using the
result of <code>rnnd_build</code> as the <code>index</code>
parameter.</li>
<li>Run <code><a href="../reference/umap_transform.html">uwot::umap_transform</a></code> with <code>nn_method</code>
set to the result of <code>rnnd_query</code>.</li>
</ul>
<p>If you don’t want to transform new data, then it’s even easier:</p>
<ul>
<li>Run <code><a href="https://jlmelville.github.io/rnndescent/reference/rnnd_knn.html" class="external-link">rnndescent::rnnd_knn</a></code> on your training data.</li>
<li>Run <code><a href="../reference/umap.html">uwot::umap</a></code> with <code>nn_method</code> set to the
result of <code>rnnd_knn</code>.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by James Melville.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>

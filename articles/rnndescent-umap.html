<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using rnndescent for nearest neighbors • uwot</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using rnndescent for nearest neighbors">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">uwot</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.2.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/uwot.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jlmelville/uwot/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Using rnndescent for nearest neighbors</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jlmelville/uwot/blob/master/vignettes/articles/rnndescent-umap.Rmd" class="external-link"><code>vignettes/articles/rnndescent-umap.Rmd</code></a></small>
      <div class="d-none name"><code>rnndescent-umap.Rmd</code></div>
    </div>

    
    
<p>This is a companion article to the <a href="https://jlmelville.github.io/uwot/articles/hnsw-umap.html">HNSW
article</a> about how to use nearest neighbor data from other packages
with <code>uwot</code>. You should read that article as well as the on
<code>uwot</code>’s <a href="https://jlmelville.github.io/uwot/articles/nearest-neighbors-format.html">nearest
neighbor format</a> for proper details. I’m going to provide minimal
commentary here.</p>
<p>The <a href="https://cran.r-project.org/package=rnndescent" class="external-link">rnndescent</a>
package can be used as an alternative to the internal Annoy-based
nearest neighbor method used by <code>uwot</code>. It is based on the
Python package <a href="https://github.com/lmcinnes/pynndescent" class="external-link">PyNNDescent</a> and
offers a wider range of metrics than other packages. See the <a href="https://jlmelville.github.io/rnndescent/articles/metrics.html" class="external-link">supported
metrics</a> article in the <code>rnndescent</code> documentation for
more details.</p>
<p><code>rnndescent</code> can also work with sparse data.
<code>uwot</code> is not yet directly compatible with sparse data input,
but for an example of using <code>rnndescent</code> with sparse data see
and then using that externally generated nearest neighbor data with
<code>uwot</code>, see the <a href="https://jlmelville.github.io/uwot/articles/sparse-data-example.html">sparse
UMAP article</a>. Here we will use typical dense data and the typical
Euclidean distance.</p>
<p>First we need some data, which I will install via the
<code>snedata</code> package from GitHub:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("pak")</span></span>
<span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pkg_install.html" class="external-link">pkg_install</a></span><span class="op">(</span><span class="st">"jlmelville/snedata"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># or</span></span>
<span><span class="co"># install.packages("devtools")</span></span>
<span><span class="co"># devtools::install_github("jlmelville/snedata")</span></span></code></pre></div>
<p>The HNSW article used the MNIST digits data, but to mix things up a
bit I’ll use the <a href="https://github.com/zalandoresearch/fashion-mnist" class="external-link">Fashion MNIST
data</a>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion</span> <span class="op">&lt;-</span> <span class="fu">snedata</span><span class="fu">::</span><span class="fu">download_fashion_mnist</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fashion_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fashion</span>, <span class="fl">60000</span><span class="op">)</span></span>
<span><span class="va">fashion_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">fashion</span>, <span class="fl">10000</span><span class="op">)</span></span></code></pre></div>
<p>This is structured just like the MNIST digits, but it uses images of
10 different classes of fashion items (e.g. trousers, dress, bag). The
name of the item is in the <code>Description</code> column.</p>
<div class="section level2">
<h2 id="installing-rnndescent">Installing rnndescent<a class="anchor" aria-label="anchor" href="#installing-rnndescent"></a>
</h2>
<p>Now install <code>rnndescent</code> from CRAN:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"rnndescent"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jlmelville.github.io/rnndescent/" class="external-link">rnndescent</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="umap-with-nndescent">UMAP with nndescent<a class="anchor" aria-label="anchor" href="#umap-with-nndescent"></a>
</h2>
<pre class="uwot"><code><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jlmelville/uwot" class="external-link">uwot</a></span><span class="op">)</span></span></code></pre>
<p><code>uwot</code> can now use <code>rnndescent</code> for its nearest
neighbor search if you set <code>nn_method = "nndescent"</code>. The
other settings are used to give reasonable results with batch mode
(although feel free to change <code>n_sgd_threads</code> to however many
threads you feel comfortable with your system using) and to return a
model we can use to embed the test set data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_train_umap</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="va">fashion_train</span>,</span>
<span>    nn_method <span class="op">=</span> <span class="st">"nndescent"</span>,</span>
<span>    batch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    n_epochs <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    n_sgd_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    ret_model <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>UMAP embedding parameters a <span class="ot">=</span> <span class="fl">1.896</span> b <span class="ot">=</span> <span class="fl">0.8006</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>Converting dataframe to numerical matrix</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>Read <span class="dv">60000</span> rows and found <span class="dv">784</span> numeric columns</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>Using alt metric <span class="st">'sqeuclidean'</span> <span class="cf">for</span> <span class="st">'euclidean'</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>Initializing neighbors using <span class="st">'tree'</span> method</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>Calculating rp tree k<span class="sc">-</span>nearest neighbors with k <span class="ot">=</span> <span class="dv">15</span> n_trees <span class="ot">=</span> <span class="dv">21</span> max leaf size <span class="ot">=</span> <span class="dv">15</span> margin <span class="ot">=</span> <span class="st">'explicit'</span> using <span class="dv">6</span> threads</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>Using euclidean margin calculation</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="dv">0</span><span class="sc">%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>[<span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span>]</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="sc">**</span><span class="er">*************************************************</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>Extracting leaf array from forest</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>Creating knn using <span class="dv">164273</span> leaves</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="dv">0</span><span class="sc">%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>[<span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span>]</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="sc">**</span><span class="er">*************************************************</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>Running nearest neighbor descent <span class="cf">for</span> <span class="dv">16</span> iterations using <span class="dv">6</span> threads</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="dv">0</span><span class="sc">%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>[<span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span>]</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a><span class="sc">**</span><span class="er">*************************************************</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>Convergence<span class="sc">:</span> c <span class="ot">=</span> <span class="dv">132</span> tol <span class="ot">=</span> <span class="dv">900</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>Finished</span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>Keeping <span class="dv">1</span> best search trees using <span class="dv">6</span> threads</span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a><span class="dv">0</span><span class="sc">%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>[<span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span>]</span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a><span class="sc">**</span><span class="er">*************************************************</span></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>Min score<span class="sc">:</span> <span class="fl">2.41727</span></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>Max score<span class="sc">:</span> <span class="fl">2.4626</span></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>Mean score<span class="sc">:</span> <span class="fl">2.44337</span></span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>Using alt metric <span class="st">'sqeuclidean'</span> <span class="cf">for</span> <span class="st">'euclidean'</span></span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>Converting graph to sparse format</span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>Diversifying forward graph</span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a>Occlusion pruning with probability<span class="sc">:</span> <span class="dv">1</span></span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a><span class="dv">0</span><span class="sc">%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>[<span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span>]</span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a><span class="sc">**</span><span class="er">*************************************************</span></span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a>Diversifying reduced <span class="co"># edges from 840000 to 240155 (0.02333% to 0.006671% sparse)</span></span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a>Degree pruning reverse graph to max degree<span class="sc">:</span> <span class="dv">22</span></span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a>Degree pruning to max <span class="dv">22</span> reduced <span class="co"># edges from 240155 to 239741 (0.006671% to 0.006659% sparse)</span></span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a>Diversifying reverse graph</span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a>Occlusion pruning with probability<span class="sc">:</span> <span class="dv">1</span></span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a><span class="dv">0</span><span class="sc">%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a>[<span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span>]</span>
<span id="cb6-43"><a href="#cb6-43" tabindex="-1"></a><span class="sc">**</span><span class="er">*************************************************</span></span>
<span id="cb6-44"><a href="#cb6-44" tabindex="-1"></a>Diversifying reduced <span class="co"># edges from 239741 to 214714 (0.006659% to 0.005964% sparse)</span></span>
<span id="cb6-45"><a href="#cb6-45" tabindex="-1"></a>Merging diversified forward and reverse graph</span>
<span id="cb6-46"><a href="#cb6-46" tabindex="-1"></a>Degree pruning merged graph to max degree<span class="sc">:</span> <span class="dv">22</span></span>
<span id="cb6-47"><a href="#cb6-47" tabindex="-1"></a>Degree pruning to max <span class="dv">22</span> reduced <span class="co"># edges from 302918 to 302882 (0.008414% to 0.008413% sparse)</span></span>
<span id="cb6-48"><a href="#cb6-48" tabindex="-1"></a>Finished preparing search graph</span>
<span id="cb6-49"><a href="#cb6-49" tabindex="-1"></a>Commencing smooth kNN distance calibration using <span class="dv">8</span> threads with target n_neighbors <span class="ot">=</span> <span class="dv">15</span></span>
<span id="cb6-50"><a href="#cb6-50" tabindex="-1"></a>Initializing from normalized Laplacian <span class="sc">+</span> <span class="fu">noise</span> (using irlba)</span>
<span id="cb6-51"><a href="#cb6-51" tabindex="-1"></a>Commencing optimization <span class="cf">for</span> <span class="dv">500</span> epochs, with <span class="dv">1359492</span> positive edges using <span class="dv">8</span> threads</span>
<span id="cb6-52"><a href="#cb6-52" tabindex="-1"></a>Using method <span class="st">'umap'</span></span>
<span id="cb6-53"><a href="#cb6-53" tabindex="-1"></a>Optimizing with Adam alpha <span class="ot">=</span> <span class="dv">1</span> beta1 <span class="ot">=</span> <span class="fl">0.5</span> beta2 <span class="ot">=</span> <span class="fl">0.9</span> eps <span class="ot">=</span> <span class="fl">1e-07</span></span>
<span id="cb6-54"><a href="#cb6-54" tabindex="-1"></a><span class="dv">0</span><span class="sc">%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span id="cb6-55"><a href="#cb6-55" tabindex="-1"></a>[<span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span></span>
<span id="cb6-56"><a href="#cb6-56" tabindex="-1"></a><span class="er">**************************************************|</span></span>
<span id="cb6-57"><a href="#cb6-57" tabindex="-1"></a>Optimization finished</span></code></pre></div>
<p>I will grant you that <code>rnndescent</code> has a <em>lot</em> to
say for itself as it goes about its business. But you can always set
<code>verbose = FALSE</code>.</p>
<div class="section level3">
<h3 id="transforming-test-data">Transforming test data<a class="anchor" aria-label="anchor" href="#transforming-test-data"></a>
</h3>
<p>Now we have a UMAP model we can transform the test set data. Now
notice that this looks exactly the same as the call we would make if we
had used Annoy for nearest neighors: all the information needed for
<code>uwot</code> to work out that it should use <code>rnndescent</code>
for querying new neighbors is encapsulated in the
<code>fashion_train_umap</code> model we generated.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_test_umap</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/umap_transform.html">umap_transform</a></span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="va">fashion_test</span>,</span>
<span>    model <span class="op">=</span> <span class="va">fashion_train_umap</span>,</span>
<span>    n_sgd_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>Read <span class="dv">10000</span> rows and found <span class="dv">784</span> numeric columns</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>Processing block <span class="dv">1</span> of <span class="dv">1</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>Reading metric data from forest</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>Using alt metric <span class="st">'sqeuclidean'</span> <span class="cf">for</span> <span class="st">'euclidean'</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>Querying rp forest <span class="cf">for</span> k <span class="ot">=</span> <span class="dv">15</span> with caching using <span class="dv">6</span> threads</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="dv">0</span><span class="sc">%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>[<span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span>]</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="sc">**</span><span class="er">*************************************************</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>Finished</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>Searching nearest neighbor graph with epsilon <span class="ot">=</span> <span class="fl">0.1</span> and max_search_fraction <span class="ot">=</span> <span class="dv">1</span> using <span class="dv">6</span> threads</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>Graph contains missing data<span class="sc">:</span> filling with random neighbors</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>Finished random fill</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a><span class="dv">0</span><span class="sc">%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>[<span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span>]</span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a><span class="sc">**</span><span class="er">*************************************************</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>min distance calculation <span class="ot">=</span> <span class="dv">0</span> (<span class="fl">0.00</span>%) of reference data</span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>max distance calculation <span class="ot">=</span> <span class="dv">1810</span> (<span class="fl">3.02</span>%) of reference data</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>avg distance calculation <span class="ot">=</span> <span class="dv">172</span> (<span class="fl">0.29</span>%) of reference data</span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>Finished</span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>Commencing smooth kNN distance calibration using <span class="dv">6</span> threads with target n_neighbors <span class="ot">=</span> <span class="dv">15</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>Initializing by weighted average of neighbor coordinates using <span class="dv">6</span> threads</span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a>Commencing optimization <span class="cf">for</span> <span class="dv">167</span> epochs, with <span class="dv">150000</span> positive edges using <span class="dv">6</span> threads</span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>Using method <span class="st">'umap'</span></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>Optimizing with Adam alpha <span class="ot">=</span> <span class="dv">1</span> beta1 <span class="ot">=</span> <span class="fl">0.5</span> beta2 <span class="ot">=</span> <span class="fl">0.9</span> eps <span class="ot">=</span> <span class="fl">1e-07</span></span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a><span class="dv">0</span><span class="sc">%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a>[<span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span></span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a><span class="er">**************************************************|</span></span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a>Finished</span></code></pre></div>
<p>Again <code>rnndescent</code> is a lot chattier than when using
Annoy.</p>
</div>
<div class="section level3">
<h3 id="plotting-the-results">Plotting the results<a class="anchor" aria-label="anchor" href="#plotting-the-results"></a>
</h3>
<p>Now to take a look at the results, using <code>ggplot2</code> for
plotting, and <code>Polychrome</code> for a suitable categorical
palette.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ggplot2"</span>, <span class="st">"Polychrome"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://oompa.r-forge.r-project.org/" class="external-link">Polychrome</a></span><span class="op">)</span></span></code></pre></div>
<p>The following code creates a palette of 10 (hopefully) visually
distinct colors which will map each point to the type of fashion item it
represents. This is found in the <code>Description</code> factor column
of the original data.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">palette</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu">Polychrome</span><span class="fu">::</span><span class="fu">createPalette</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">fashion</span><span class="op">$</span><span class="va">Description</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span>,</span>
<span>  seedcolors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#ffffff"</span>, <span class="st">"#000000"</span><span class="op">)</span>,</span>
<span>  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">90</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>And here are the results:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">fashion_train_umap</span><span class="op">$</span><span class="va">embedding</span>, Description <span class="op">=</span> <span class="va">fashion_train</span><span class="op">$</span><span class="va">Description</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X1</span>, y <span class="op">=</span> <span class="va">X2</span>, color <span class="op">=</span> <span class="va">Description</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.1</span>, size <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">palette</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Fashion MNIST training set UMAP"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">""</span>,</span>
<span>    y <span class="op">=</span> <span class="st">""</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Description"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">fashion_test_umap</span>, Description <span class="op">=</span> <span class="va">fashion_test</span><span class="op">$</span><span class="va">Description</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X1</span>, y <span class="op">=</span> <span class="va">X2</span>, color <span class="op">=</span> <span class="va">Description</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.4</span>, size <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">palette</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Fashion MNIST test set UMAP"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">""</span>,</span>
<span>    y <span class="op">=</span> <span class="st">""</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Description"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="img/rnndescent-umap/fashion-train.png" alt="Fashion training data"><img src="img/rnndescent-umap/fashion-test.png" alt="Fashion test set"></p>
<p>These results are typical for Fashion MNIST result with UMAP. For
example, see the first image in <a href="https://umap-learn.readthedocs.io/en/latest/supervised.html#umap-on-fashion-mnist" class="external-link">part
of the Python UMAP documentation</a>. So it looks like
<code>rnndescent</code> with its default settings does a good job with
this dataset.</p>
</div>
</div>
<div class="section level2">
<h2 id="a-minor-advantage-of-using-rnndescent">A Minor Advantage of using <code>rnndescent</code><a class="anchor" aria-label="anchor" href="#a-minor-advantage-of-using-rnndescent"></a>
</h2>
<p>If you use <code>nn_method = "nndescent"</code> then the UMAP model
returned with <code>ret_model = TRUE</code> can be saved and loaded
using the standard R functions <code>saveRDS</code> and
<code>readRDS</code>. You don’t need to the use
<code>uwot</code>-specific <code>save_uwot</code> and
<code>load_uwot</code>, nor do you need to worry about unloading the
model with <code>unload_uwot</code>, as you must with Annoy-based UMAP
models. This is a consequence of <code>rnndescent</code> storing all its
index-related data in pure R (no wrapping of existing C++ classes), but
be aware that this can lead to much larger models on disk and in
RAM.</p>
</div>
<div class="section level2">
<h2 id="using-rnndescent-externally">Using <code>rnndescent</code> externally<a class="anchor" aria-label="anchor" href="#using-rnndescent-externally"></a>
</h2>
<p>If you want more control over the behavior of <code>rnndescent</code>
then you can use it directly to create a nearest neighbor graph and then
pass that result to the <code>nn_method</code> argument of
<code>umap</code>. This isn’t usually necessary and if you <em>do</em>
want more control I recommend using the <code>nn_args</code> argument of
<code>umap</code>, which is a list of arguments to pass directly to
<code>rnndescent</code>. If you decide to use <code>rnndescent</code>
directly, the following section mainly uses default argument but
demonstrates a workflow that can be customized for your own needs. The
resulting UMAP plots will be essentially identical to those that are
output when using <code>nn_mmethod = "nndescent"</code>.</p>
<div class="section level3">
<h3 id="build-an-index-for-the-training-data">Build an index for the training data<a class="anchor" aria-label="anchor" href="#build-an-index-for-the-training-data"></a>
</h3>
<p>First, we will build a search index using the training data. You
should use as many threads (<code>n_threads</code>) as you feel
comfortable with. You can also set <code>verbose = TRUE</code>, but when
building an index you will see a lot of output so I won’t reproduce that
here. The <code>k</code> parameter is the number of nearest neighbors
that we are looking for. The index is tuned to work well for that number
of neighbors. The <code>metric</code> parameter is the distance metric
to use, but the default is Euclidean, so we don’t need to specify that.
Finally, there is a stochastic aspect to the index building. You may get
slightly different results from me, but I am leaving the seed unset so
that we must both live with the inherently random nature of the index
building process.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/rnnd_build.html" class="external-link">rnnd_build</a></span><span class="op">(</span><span class="va">fashion_train</span>, k <span class="op">=</span> <span class="fl">15</span>, n_threads <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<p>What’s in the returned index? A bunch of stuff:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fashion_index</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"graph"</span>           <span class="st">"prep"</span>            <span class="st">"data"</span>            <span class="st">"original_metric"</span> <span class="st">"use_alt_metric"</span>  <span class="st">"search_forest"</span>   <span class="st">"search_graph"</span></span></code></pre></div>
<p>Most of that is there to support searching the index. What we want is
the <code>graph</code>. This is a list with two elements,
<code>idx</code> and <code>dist</code>, which contain the nearest
neighbor indices and distances respectively. The nearest neighbor of
each item is itself, so we expect the first column of <code>idx</code>
to be the sequence 1, 2, 3, … and the first column of <code>dist</code>
to be all zeros.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_index</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">idx</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>     [,<span class="dv">1</span>]  [,<span class="dv">2</span>]  [,<span class="dv">3</span>]</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>[<span class="dv">1</span>,]    <span class="dv">1</span> <span class="dv">25720</span> <span class="dv">27656</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>[<span class="dv">2</span>,]    <span class="dv">2</span> <span class="dv">42565</span> <span class="dv">37551</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>[<span class="dv">3</span>,]    <span class="dv">3</span> <span class="dv">53514</span> <span class="dv">35425</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_index</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">dist</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>     [,<span class="dv">1</span>]      [,<span class="dv">2</span>]      [,<span class="dv">3</span>]</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>[<span class="dv">1</span>,]    <span class="dv">0</span> <span class="fl">1188.7826</span> <span class="fl">1215.3440</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>[<span class="dv">2</span>,]    <span class="dv">0</span> <span class="fl">1048.0482</span> <span class="fl">1068.3951</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>[<span class="dv">3</span>,]    <span class="dv">0</span>  <span class="fl">532.6199</span>  <span class="fl">632.1653</span></span></code></pre></div>
<p>With other nearest neighbor methods like HNSW and Annoy, you would
have to run a separate query step to get the k-nearest neighbors for the
data used to build the index. One of the advantages of
<code>rnndescent</code> is that you can get this data directly from the
index without the separate query step. Note that you can still query the
index if you want to, and those results might be a bit more accurate,
but I am quietly confident that the results from the index are
sufficient for UMAP.</p>
</div>
<div class="section level3">
<h3 id="query-the-test-data">Query the test data<a class="anchor" aria-label="anchor" href="#query-the-test-data"></a>
</h3>
<p>To get the test set neighbors, query the index with the test
data:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_test_query_neighbors</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/rnnd_query.html" class="external-link">rnnd_query</a></span><span class="op">(</span></span>
<span>    index <span class="op">=</span> <span class="va">fashion_index</span>,</span>
<span>    query <span class="op">=</span> <span class="va">fashion_test</span>,</span>
<span>    k <span class="op">=</span> <span class="fl">15</span>,</span>
<span>    n_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_test_query_neighbors</span><span class="op">$</span><span class="va">idx</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>      [,<span class="dv">1</span>]  [,<span class="dv">2</span>]  [,<span class="dv">3</span>]</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>[<span class="dv">1</span>,] <span class="dv">18095</span> <span class="dv">53940</span> <span class="dv">18353</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>[<span class="dv">2</span>,]  <span class="dv">8573</span> <span class="dv">31349</span>  <span class="dv">3885</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>[<span class="dv">3</span>,]   <span class="dv">286</span> <span class="dv">38144</span>  <span class="dv">3422</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_test_query_neighbors</span><span class="op">$</span><span class="va">dist</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>          [,<span class="dv">1</span>]      [,<span class="dv">2</span>]      [,<span class="dv">3</span>]</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>[<span class="dv">1</span>,]  <span class="fl">482.2966</span>  <span class="fl">681.9905</span>  <span class="fl">708.4991</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>[<span class="dv">2</span>,] <span class="fl">1308.0019</span> <span class="fl">1329.3134</span> <span class="fl">1382.7317</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>[<span class="dv">3</span>,]  <span class="fl">466.0322</span>  <span class="fl">538.5378</span>  <span class="fl">555.8795</span></span></code></pre></div>
<p>As we are querying the test data against the training data, the
nearest neighbor of any test item is <em>not</em> the test item
itself.</p>
<p>We now have all the nearest neighbor data we need. The good news is
that it’s already in a format that <code>uwot</code> can use so we can
proceed straight to running UMAP.</p>
</div>
</div>
<div class="section level2">
<h2 id="using-rnndescent-nearest-neighbors-with-umap">Using rnndescent nearest neighbors with UMAP<a class="anchor" aria-label="anchor" href="#using-rnndescent-nearest-neighbors-with-umap"></a>
</h2>
<div class="section level3">
<h3 id="umap-on-training-data">UMAP on training data<a class="anchor" aria-label="anchor" href="#umap-on-training-data"></a>
</h3>
<p>To use pre-computed nearest neighbor data with <code>uwot</code> pass
it as the <code>nn_method</code> parameter. In this case, that is the
<code>graph</code> item in <code>fashion_index</code>. See the HSNW
article for more details on the other parameters, but this is designed
to give pretty typical UMAP results.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_train_umap</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    nn_method <span class="op">=</span> <span class="va">fashion_index</span><span class="op">$</span><span class="va">graph</span>,</span>
<span>    batch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    n_epochs <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    n_sgd_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    ret_model <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>UMAP embedding parameters a <span class="ot">=</span> <span class="fl">1.896</span> b <span class="ot">=</span> <span class="fl">0.8006</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>Commencing smooth kNN distance calibration using <span class="dv">6</span> threads with target n_neighbors <span class="ot">=</span> <span class="dv">15</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>Initializing from normalized Laplacian <span class="sc">+</span> <span class="fu">noise</span> (using irlba)</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>Commencing optimization <span class="cf">for</span> <span class="dv">500</span> epochs, with <span class="dv">1359454</span> positive edges using <span class="dv">6</span> threads</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>Using method <span class="st">'umap'</span></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>Optimizing with Adam alpha <span class="ot">=</span> <span class="dv">1</span> beta1 <span class="ot">=</span> <span class="fl">0.5</span> beta2 <span class="ot">=</span> <span class="fl">0.9</span> eps <span class="ot">=</span> <span class="fl">1e-07</span></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a><span class="dv">0</span><span class="sc">%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>[<span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a><span class="er">**************************************************|</span></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>Optimization finished</span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>Note<span class="sc">:</span> model requested with precomputed neighbors. For transforming new data, distance data must be provided separately</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="transforming-test-data-1">Transforming test data<a class="anchor" aria-label="anchor" href="#transforming-test-data-1"></a>
</h3>
<p>Now we have a UMAP model we can transform the test set data. Once
again we don’t need to pass in any test set data except the neighbors as
<code>nn_method</code>:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_test_umap</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/umap_transform.html">umap_transform</a></span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    model <span class="op">=</span> <span class="va">fashion_train_umap</span>,</span>
<span>    nn_method <span class="op">=</span> <span class="va">fashion_test_query_neighbors</span>,</span>
<span>    n_sgd_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>Read <span class="dv">10000</span> rows</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>Processing block <span class="dv">1</span> of <span class="dv">1</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>Commencing smooth kNN distance calibration using <span class="dv">6</span> threads with target n_neighbors <span class="ot">=</span> <span class="dv">15</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>Initializing by weighted average of neighbor coordinates using <span class="dv">6</span> threads</span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>Commencing optimization <span class="cf">for</span> <span class="dv">167</span> epochs, with <span class="dv">150000</span> positive edges using <span class="dv">6</span> threads</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>Using method <span class="st">'umap'</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>Optimizing with Adam alpha <span class="ot">=</span> <span class="dv">1</span> beta1 <span class="ot">=</span> <span class="fl">0.5</span> beta2 <span class="ot">=</span> <span class="fl">0.9</span> eps <span class="ot">=</span> <span class="fl">1e-07</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a><span class="dv">0</span><span class="sc">%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>[<span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a><span class="er">**************************************************|</span></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a>Finished</span></code></pre></div>
<p>At this point you can plot the results, which will resemble those
shown earlier.</p>
</div>
<div class="section level3">
<h3 id="a-potentially-simpler-workflow">A potentially simpler workflow<a class="anchor" aria-label="anchor" href="#a-potentially-simpler-workflow"></a>
</h3>
<p>If you don’t want to transform new data, you can make life a bit
easier. Instead of <code>rnnd_build</code>, use <code>rnnd_knn</code>
which behaves a lot like <code>rnnd_build</code> but doesn’t preserve
the index or do any index preparation. This saves time and the nearest
neighbor results are returned directly in the return result. Let’s use
the full Fashion MNIST results as an example:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_knn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://jlmelville.github.io/rnndescent/reference/rnnd_knn.html" class="external-link">rnnd_knn</a></span><span class="op">(</span><span class="va">fashion</span>, k <span class="op">=</span> <span class="fl">15</span>, n_threads <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fashion_knn</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"idx"</span>  <span class="st">"dist"</span></span></code></pre></div>
<p>You can then pass <code>fashion_knn</code> to
<code>nn_method</code>:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fashion_umap</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    nn_method <span class="op">=</span> <span class="va">fashion_knn</span>,</span>
<span>    batch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    n_epochs <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    n_sgd_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>(I have spared you the log output). We don’t need to pass
<code>ret_model = TRUE</code> here because we can’t transform new data.
Here is the UMAP plot for the full Fashion MNIST dataset:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">fashion_umap</span>, Description <span class="op">=</span> <span class="va">fashion</span><span class="op">$</span><span class="va">Description</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X1</span>, y <span class="op">=</span> <span class="va">X2</span>, color <span class="op">=</span> <span class="va">Description</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.1</span>, size <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">palette</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Fashion MNIST UMAP"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">""</span>,</span>
<span>    y <span class="op">=</span> <span class="st">""</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Description"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="img/rnndescent-umap/fashion-umap.png" alt="fashion UMAP"><div class="figcaption">fashion UMAP</div>
</div>
<p>Everything looks as expected. However, if you think you might want to
transform new data in the future, then you will need to completely
restart the process, with <code>rnnd_build</code> and using
<code>ret_model = TRUE</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusions">Conclusions<a class="anchor" aria-label="anchor" href="#conclusions"></a>
</h2>
<p>If you want to use <code>rnndescent</code> with <code>uwot</code>,
then:</p>
<ul>
<li>Install <code>rnndescent</code> and then use
<code>nn_method = "nndescent"</code>.</li>
</ul>
<p>That handles most cases. If you want to use precomputed nearest
neighbors, then:</p>
<ul>
<li>Run <code><a href="https://jlmelville.github.io/rnndescent/reference/rnnd_build.html" class="external-link">rnndescent::rnnd_build</a></code> on your training data.</li>
<li>Run <code><a href="../reference/umap.html">uwot::umap</a></code> with <code>nn_method</code> set to the
<code>graph</code> item in the result of <code>rnnd_build</code> and
remember to set <code>ret_model = TRUE</code>.</li>
</ul>
<p>To transform new data:</p>
<ul>
<li>Run <code><a href="https://jlmelville.github.io/rnndescent/reference/rnnd_query.html" class="external-link">rnndescent::rnnd_query</a></code> on your test data, using the
result of <code>rnnd_build</code> as the <code>index</code>
parameter.</li>
<li>Run <code><a href="../reference/umap_transform.html">uwot::umap_transform</a></code> with <code>nn_method</code>
set to the result of <code>rnnd_query</code>.</li>
</ul>
<p>If you don’t want to transform new data, then it’s even easier:</p>
<ul>
<li>Run <code><a href="https://jlmelville.github.io/rnndescent/reference/rnnd_knn.html" class="external-link">rnndescent::rnnd_knn</a></code> on your training data.</li>
<li>Run <code><a href="../reference/umap.html">uwot::umap</a></code> with <code>nn_method</code> set to the
result of <code>rnnd_knn</code>.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James Melville.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>uwot • uwot</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="uwot">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">uwot</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/uwot.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jlmelville/uwot/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>uwot</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jlmelville/uwot/blob/v0.2.3/vignettes/uwot.Rmd" class="external-link"><code>vignettes/uwot.Rmd</code></a></small>
      <div class="d-none name"><code>uwot.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jlmelville/uwot" class="external-link">uwot</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: Matrix</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/yixuan/RSpectra" class="external-link">RSpectra</a></span><span class="op">)</span></span></code></pre></div>
<p><code>uwot</code> is the a package for implementing the UMAP
dimensionality reduction method. For more information on UMAP, see the
<a href="https://arxiv.org/abs/1802.03426" class="external-link">original paper</a> and the <a href="https://github.com/lmcinnes/umap" class="external-link">Python package</a>.</p>
<p>We’ll use the <code>iris</code> dataset in these examples. It’s not
the ideal dataset because it’s not terribly large nor high-dimensional
(with only 4 numeric columns), but you’ll get the general idea.</p>
<p>The default output dimensionality of UMAP is into two-dimensions, so
it’s amenable for visualization, but you can set a larger value with
<code>n_components</code>. In this vignette we’ll stick with two
dimensions. We will need a function to make plotting easier:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kabsch</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pm</span>, <span class="va">qm</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pm_dims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">pm</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">qm</span><span class="op">)</span> <span class="op">==</span> <span class="va">pm_dims</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span>call. <span class="op">=</span> <span class="cn">TRUE</span>, <span class="st">"Point sets must have the same dimensions"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># The rotation matrix will have (ncol - 1) leading ones in the diagonal</span></span>
<span>  <span class="va">diag_ones</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">pm_dims</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># center the points</span></span>
<span>  <span class="va">pm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">pm</span>, center <span class="op">=</span> <span class="cn">TRUE</span>, scale <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">qm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">qm</span>, center <span class="op">=</span> <span class="cn">TRUE</span>, scale <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">am</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matmult-methods.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">pm</span>, <span class="va">qm</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">svd_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html" class="external-link">svd</a></span><span class="op">(</span><span class="va">am</span><span class="op">)</span></span>
<span>  <span class="co"># use the sign of the determinant to ensure a right-hand coordinate system</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/det.html" class="external-link">determinant</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matmult-methods.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">svd_res</span><span class="op">$</span><span class="va">v</span>, <span class="va">svd_res</span><span class="op">$</span><span class="va">u</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">sign</span></span>
<span>  <span class="va">dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">diag_ones</span>, <span class="va">d</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># rotation matrix</span></span>
<span>  <span class="va">um</span> <span class="op">&lt;-</span> <span class="va">svd_res</span><span class="op">$</span><span class="va">v</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matmult-methods.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">dm</span>, <span class="va">svd_res</span><span class="op">$</span><span class="va">u</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Rotate and then translate to the original centroid location of qm</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matmult-methods.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">um</span>, <span class="va">pm</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">qm</span>, <span class="st">"scaled:center"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">iris_pca2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">plot_umap</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">coords</span>, <span class="va">col</span> <span class="op">=</span> <span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, <span class="va">pca</span> <span class="op">=</span> <span class="va">iris_pca2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">kabsch</span><span class="op">(</span><span class="va">coords</span>, <span class="va">pca</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">col</span>, xlab <span class="op">=</span> <span class="st">""</span>, ylab <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Most of this code is just the <a href="https://en.wikipedia.org/wiki/Kabsch_algorithm" class="external-link">kabsch
algorithm</a> to align two point sets, which I am going to use to align
the results of UMAP over the first two principal components. This is to
keep the relative orientation of the output the same across different
plots which makes it a bit easier to see the differences between them.
UMAP is a stochastic algorithm so the output will be different each time
you run it and small changes to the parameters can affect the
<em>absolute</em> values of the coordinates, although the interpoint
differences are usually similar. There’s no need to go to such trouble
in most circumstances: the output of <code>umap</code> is a perfectly
useful 2D matrix of coordinates you can pass into a plotting function
with no further processing required.</p>
<div class="section level2">
<h2 id="basic-umap">Basic UMAP<a class="anchor" aria-label="anchor" href="#basic-umap"></a>
</h2>
<p>The defaults of the <code>umap</code> function should work for most
datasets. No scaling of the input data is done, but non-numeric columns
are ignored:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">iris_umap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span><span class="fu">plot_umap</span><span class="op">(</span><span class="va">iris_umap</span><span class="op">)</span></span></code></pre></div>
<p><img src="uwot_files/figure-html/basic%20UMAP-1.png" width="700"></p>
<div class="section level3">
<h3 id="parameters">Parameters<a class="anchor" aria-label="anchor" href="#parameters"></a>
</h3>
<p><code>uwot</code> has accumulated many parameters over time, but most
of the time there are only a handful you need worry about. The most
important ones are:</p>
<div class="section level4">
<h4 id="min_dist">
<code>min_dist</code><a class="anchor" aria-label="anchor" href="#min_dist"></a>
</h4>
<p>This is a mainly aesthetic parameter, which defines how close points
can get in the output space. A smaller value tends to make any clusters
in the output more compact. You should experiment with values between 0
and 1, although don’t choose exactly zero. The default is 0.01, which
seems like it’s a bit small for <code>iris</code>. Let’s crank up
<code>min_dist</code> to <code>0.3</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">iris_umap_md05</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span><span class="va">iris</span>, min_dist <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="fu">plot_umap</span><span class="op">(</span><span class="va">iris_umap_md05</span><span class="op">)</span></span></code></pre></div>
<p><img src="uwot_files/figure-html/min_dist%200.5-1.png" width="700"></p>
<p>This has made the clusters bigger and closer together, so we’ll use
<code>min_dist = 0.3</code> for the other examples with
<code>iris</code>.</p>
</div>
<div class="section level4">
<h4 id="n_neighbors">
<code>n_neighbors</code><a class="anchor" aria-label="anchor" href="#n_neighbors"></a>
</h4>
<p>This defines the number of items in the dataset that define the
neighborhood around each point. Set it too low and you will get a more
fragmented layout. Set it too high and you will get something that will
miss a lot of local structure.</p>
<p>Here’s a result with 5 neighbors:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">iris_umap_nbrs5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span><span class="va">iris</span>, n_neighbors <span class="op">=</span> <span class="fl">5</span>, min_dist <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="fu">plot_umap</span><span class="op">(</span><span class="va">iris_umap_nbrs5</span><span class="op">)</span></span></code></pre></div>
<p><img src="uwot_files/figure-html/5%20neighbors-1.png" width="700"></p>
<p>It’s not hugely different from the default of 15 neighbors, but the
clusters are a bit more broken up.</p>
<p>There should be a more pronounced difference going the other way and
looking at 100 neighbors:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">iris_umap_nbrs100</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span><span class="va">iris</span>, n_neighbors <span class="op">=</span> <span class="fl">100</span>, min_dist <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="fu">plot_umap</span><span class="op">(</span><span class="va">iris_umap_nbrs100</span><span class="op">)</span></span></code></pre></div>
<p><img src="uwot_files/figure-html/100%20neighbors-1.png" width="700"></p>
<p>Here there is a much more uniform appearance to the results. It’s
always worth trying a few different values of <code>n_neighbors</code>,
especially larger values, although larger values of
<code>n_neighbors</code> will lead to longer run times. Sometimes small
clusters that you think are meaningful may in fact be artifacts of
setting <code>n_neighbors</code> too small, so starting with a larger
value and looking at the effect of reducing <code>n_neighbors</code> can
help you avoid over interpreting results.</p>
</div>
<div class="section level4">
<h4 id="init">
<code>init</code><a class="anchor" aria-label="anchor" href="#init"></a>
</h4>
<p>The default initialization of UMAP is to use spectral initialization,
which acts upon the (symmetrized) k-nearest neighbor graph that is in
determined by your choice of <code>n_neighbors</code>. This is usually a
good choice, but it involves a very sparse matrix, which can sometimes
be a bit <em>too</em> sparse, which leads to numerical difficulties
which manifest as slow run times or even hanging calculations. If your
dataset causes these issues, you can either try increasing
<code>n_neighbors</code> but I have seen cases where that would be
inconvenient in terms of CPU and RAM usage. An alternative is to use the
first two principal components of the data, which at least uses the data
you provide to give a solid global picture of the data that UMAP can
refine. It’s not appropriate for every dataset, but in most cases, it’s
a perfectly good alternative.</p>
<p>The only gotcha with it is that depending on the scaling of your
data, the initial coordinates can have large inter-point distances. UMAP
will not optimize that well, so such an output should be scaled to a
small standard deviation. If you set <code>init = "spca"</code>, it will
do all that for you, although to be more aligned with the UMAP
coordinate initialization, I recommend you also set
<code>init_sdev = "range"</code> as well. <code>init_sdev</code> can
also take a numerical value for the standard deviation. Values from
<code>1e-4</code> to <code>10</code> are reasonable, but I recommend you
stick to the default of <code>"range"</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">iris_umap_spca</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span><span class="va">iris</span>,</span>
<span>    init <span class="op">=</span> <span class="st">"spca"</span>,</span>
<span>    init_sdev <span class="op">=</span> <span class="st">"range"</span>,</span>
<span>    min_dist <span class="op">=</span> <span class="fl">0.3</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">plot_umap</span><span class="op">(</span><span class="va">iris_umap_spca</span><span class="op">)</span></span></code></pre></div>
<p><img src="uwot_files/figure-html/spca%20init-1.png" width="700"></p>
<p>This doesn’t have a big effect on <code>iris</code>, but it’s good to
know about this as an option: and it can also smooth out the effect of
changing <code>n_neighbors</code> on the initial coordinates with the
standard spectral initialization, which can make it easier to see the
effect of changing <code>n_neighbors</code> on the final result.</p>
<p>Some other <code>init</code> options to know about:</p>
<ul>
<li>
<code>"random"</code>: if the worst comes to the worst, you can
always fall back to randomly assigning the initial coordinates. You
really want to avoid this if you can though, because it will take longer
to optimize the coordinates to the same quality, so you will need to
increase <code>n_epochs</code> to compensate. Even if you do that, it’s
<em>much</em> more likely that you will end up in a minimum that is less
desirable than one based on a good initialization. This will make
interpreting the results harder, as you are more likely to end up with
different clusters beings split or mixed with each other.</li>
<li>If you have some coordinates you like from another method, you can
pass them in as a matrix. But remember will probably want to scale them
with <code>init_sdev</code> though.</li>
</ul>
</div>
<div class="section level4">
<h4 id="dens_scale">
<code>dens_scale</code><a class="anchor" aria-label="anchor" href="#dens_scale"></a>
</h4>
<p>The <code>dens_scale</code> parameter varies from 0 to 1 and controls
how much of the relative densities of the input data is attempted to be
preserved in the output.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">iris_umapds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span><span class="va">iris</span>, min_dist <span class="op">=</span> <span class="fl">0.3</span>, dens_scale <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="fu">plot_umap</span><span class="op">(</span><span class="va">iris_umapds</span><span class="op">)</span></span></code></pre></div>
<p><img src="uwot_files/figure-html/UMAP%20with%20density%20scaling-1.png" width="700"></p>
<p>This has shrunk the black cluster on the left of the plot (those are
of species <code>setosa</code>), which reflect that the density of the
<code>setosa</code> points is less spread out in the input data than the
other two species. For more on <code>dens_scale</code> please read its
dedicated <a href="https://jlmelville.github.io/uwot/articles/leopold.html">article</a>.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="embedding-new-data">Embedding New Data<a class="anchor" aria-label="anchor" href="#embedding-new-data"></a>
</h2>
<p>Once you have an embedding, you can use it to embed new data,
although you need to remember to ask for a “model” to return. Instead of
just the coordinates, you will now get back a list which contains all
the extra parameters you will need for transforming new data. The
coordinates are still available in the <code>$embedding</code>
component.</p>
<p>Let’s try building a UMAP with just the <code>setosa</code> and
<code>versicolor</code> iris species:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="va">iris_train</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"setosa"</span>, <span class="st">"versicolor"</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">iris_train_umap</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/umap.html">umap</a></span><span class="op">(</span><span class="va">iris_train</span>, min_dist <span class="op">=</span> <span class="fl">0.3</span>, ret_model <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">iris_train_umap</span><span class="op">$</span><span class="va">embedding</span>,</span>
<span>  col <span class="op">=</span> <span class="va">iris_train</span><span class="op">$</span><span class="va">Species</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">""</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">""</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"UMAP setosa + versicolor"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="uwot_files/figure-html/create%20a%20UMAP%20model-1.png" width="700"></p>
<p>Next, you can use <code>umap_transform</code> to embed the new
points:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_test</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"virginica"</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">iris_test_umap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/umap_transform.html">umap_transform</a></span><span class="op">(</span><span class="va">iris_test</span>, <span class="va">iris_train_umap</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">iris_train_umap</span><span class="op">$</span><span class="va">embedding</span>, <span class="va">iris_test_umap</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="va">iris</span><span class="op">$</span><span class="va">Species</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">""</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">""</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"UMAP transform virginica"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="uwot_files/figure-html/embed%20new%20coordinates-1.png" width="700"></p>
<p>The green points in the top-right show the embedded data. Note that
the original (black and red) clusters do not get optimized any further.
While we haven’t perfectly reproduced the full UMAP, the
<code>virginica</code> points are located in more or less the right
place, close to the <code>versicolor</code> items. Just like with any
machine learning method, you must be careful with how you choose your
training set.</p>
</div>
<div class="section level2">
<h2 id="supported-distances">Supported Distances<a class="anchor" aria-label="anchor" href="#supported-distances"></a>
</h2>
<p>For small (N &lt; 4096) and Euclidean distance, exact nearest
neighbors are found using the <a href="https://cran.r-project.org/package=FNN" class="external-link">FNN</a> package.
Otherwise, approximate nearest neighbors are found using <a href="https://cran.r-project.org/package=RcppAnnoy" class="external-link">RcppAnnoy</a>. The
supported distance metrics (set by the <code>metric</code> parameter)
are:</p>
<ul>
<li>Euclidean</li>
<li>Cosine</li>
<li>Pearson Correlation (<code>correlation</code>)</li>
<li>Manhattan</li>
<li>Hamming</li>
</ul>
<p>Exactly what constitutes the cosine distance can differ between
packages. <code>uwot</code> tries to follow how the Python version of
UMAP defines it, which is 1 minus the cosine similarity. This differs
slightly from how Annoy defines its angular distance, so be aware that
<code>uwot</code> internally converts the Annoy version of the distance.
Also be aware that the Pearson correlation distance is the cosine
distance applied to row-centered vectors.</p>
<p>If you need other metrics, and can generate the nearest neighbor info
externally, you can pass the data directly to <code>uwot</code> via the
<code>nn_method</code> parameter. Please note that the Hamming support
is a lot slower than the other metrics. I do not recommend using it if
you have more than a few hundred features, and even then expect it to
take several minutes during the index building phase in situations where
the Euclidean metric would take only a few seconds.</p>
</div>
<div class="section level2">
<h2 id="multi-threading-support">Multi-threading support<a class="anchor" aria-label="anchor" href="#multi-threading-support"></a>
</h2>
<p>Parallelization can be used for the nearest neighbor index search,
the smooth knn/perplexity calibration, and the optimization, which is
the same approach that <a href="https://github.com/lferry007/LargeVis" class="external-link">LargeVis</a> takes.</p>
<p>You can (and should) adjust the number of threads via the
<code>n_threads</code>, which controls the nearest neighbor and smooth
knn calibration, and the <code>n_sgd_threads</code> parameter, which
controls the number of threads used during optimization. For the
<code>n_threads</code>, the default is the number of available cores.
For <code>n_sgd_threads</code> the default is <code>0</code>, which
ensures reproducibility of results with a fixed seed.</p>
</div>
<div class="section level2">
<h2 id="python-comparison">Python Comparison<a class="anchor" aria-label="anchor" href="#python-comparison"></a>
</h2>
<p>For the datasets I’ve tried it with, the results look at least
reminiscent of those obtained using the <a href="https://github.com/lmcinnes/umap" class="external-link">official Python
implementation</a>. Below are results for the 70,000 MNIST digits
(downloaded using the <a href="https://github.com/jlmelville/snedata" class="external-link">snedata</a> package).
Below, is the result of using the official Python UMAP implementation
(via the <a href="https://cran.r-project.org/package=reticulate" class="external-link">reticulate</a>
package). Under that is the result of using <code>uwot</code>.</p>
<div class="figure">
<img src="mnist-py.png" alt="MNIST UMAP (Python)" width="75%"><p class="caption">
MNIST UMAP (Python)
</p>
</div>
<div class="figure">
<img src="mnist-r.png" alt="MNIST UMAP (R)" width="75%"><p class="caption">
MNIST UMAP (R)
</p>
</div>
<p>The project documentation contains some more <a href="https://jlmelville.github.io/uwot/articles/umap-examples.html">examples</a>,
and <a href="https://jlmelville.github.io/uwot/articles/pycompare.html">comparison
with Python</a>.</p>
</div>
<div class="section level2">
<h2 id="limitations-and-other-issues">Limitations and Other Issues<a class="anchor" aria-label="anchor" href="#limitations-and-other-issues"></a>
</h2>
<div class="section level3">
<h3 id="nearest-neighbor-calculation">Nearest Neighbor Calculation<a class="anchor" aria-label="anchor" href="#nearest-neighbor-calculation"></a>
</h3>
<p><code>uwot</code> leans heavily on the <a href="https://github.com/spotify/annoy" class="external-link">Annoy</a> library for
approximate nearest neighbor search. As a result, compared to the Python
version of UMAP, <code>uwot</code> has much more limited support for
different distance measurements, and no support for sparse matrix data
input.</p>
<p>However, <code>uwot</code> <em>does</em> let you pass in nearest
neighbor data. So if you have access to other nearest neighbor methods,
you can generate data that can be used with <code>uwot</code>. See the
<a href="https://jlmelville.github.io/uwot/articles/nearest-neighbors-format.html">Nearest
Neighbor Data Format</a> article. Or if you can calculate a distance
matrix for your data, you can pass it in as <code>dist</code>
object.</p>
<p>For larger distance matrices, you can pass in a
<code>sparseMatrix</code> (from the <a href="https://cran.r-project.org/package=Matrix" class="external-link">Matrix</a>
package).</p>
<p>Experience with <a href="https://cave.cs.columbia.edu/repository/COIL-100" class="external-link">COIL-100</a>,
which has 49,152 features, suggests that Annoy will <em>definitely</em>
struggle with datasets of this dimensionality. Even 3000 dimensions can
cause problems, although this is not a difficulty specific to Annoy.
Reducing the dimensionality with PCA to an intermediate dimensionality
(e.g. 100) can help. Use e.g. <code>pca = 100</code> to do this. This
can also be slow on platforms without good linear algebra support and
you should assure yourself that 100 principal components won’t be
throwing away excessive amounts of information.</p>
</div>
<div class="section level3">
<h3 id="spectral-initialization">Spectral Initialization<a class="anchor" aria-label="anchor" href="#spectral-initialization"></a>
</h3>
<p>The spectral initialization default for <code>umap</code> (and the
Laplacian Eigenmap initialization, <code>init = "laplacian"</code>) can
sometimes run into problems. If it fails to converge it will fall back
to random initialization, but on occasion I’ve seen it take an extremely
long time (a couple of hours) to converge. Recent changes have hopefully
reduced the chance of this happening, but if initialization is taking
more than a few minutes, I suggest stopping the calculation and using
the scaled PCA (<code>init = "spca"</code>) instead.</p>
</div>
</div>
<div class="section level2">
<h2 id="supporting-libraries">Supporting Libraries<a class="anchor" aria-label="anchor" href="#supporting-libraries"></a>
</h2>
<p>All credit to the following packages which do a lot of the hard
work:</p>
<ul>
<li>Coordinate initialization uses <a href="https://cran.r-project.org/package=RSpectra" class="external-link">RSpectra</a> to do
the eigendecomposition of the normalized Laplacian.</li>
<li>The optional PCA initialization and initial dimensionality reduction
uses <a href="https://cran.r-project.org/package=irlba" class="external-link">irlba</a>.</li>
<li>The smooth k-nearest neighbor distance and stochastic gradient
descent optimization routines are written in C++ (using <a href="https://cran.r-project.org/package=Rcpp" class="external-link">Rcpp</a>, aping the
Python code as closely as possible.</li>
<li>Some of the multi-threading code is based on <a href="https://github.com/RcppCore/RcppParallel" class="external-link">RcppParallel</a>.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James Melville.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>

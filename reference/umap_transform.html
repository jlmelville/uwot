<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Carry out an embedding of new data using an existing embedding. Requires
using the result of calling umap or tumap with
ret_model = TRUE."><title>Add New Points to an Existing Embedding — umap_transform • uwot</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Add New Points to an Existing Embedding — umap_transform"><meta property="og:description" content="Carry out an embedding of new data using an existing embedding. Requires
using the result of calling umap or tumap with
ret_model = TRUE."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">uwot</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.16.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="../articles/uwot.html">Get started</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/jlmelville/uwot/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Add New Points to an Existing Embedding</h1>
      <small class="dont-index">Source: <a href="https://github.com/jlmelville/uwot/blob/HEAD/R/transform.R" class="external-link"><code>R/transform.R</code></a></small>
      <div class="d-none name"><code>umap_transform.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Carry out an embedding of new data using an existing embedding. Requires
using the result of calling <code><a href="umap.html">umap</a></code> or <code><a href="tumap.html">tumap</a></code> with
<code>ret_model = TRUE</code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">umap_transform</span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  model <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  nn_method <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  init_weighted <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  search_k <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  tmpdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  n_epochs <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  n_threads <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  n_sgd_threads <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  grain_size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  init <span class="op">=</span> <span class="st">"weighted"</span>,</span>
<span>  batch <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  learning_rate <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  opt_args <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  epoch_callback <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  ret_extra <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  seed <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>X</dt>
<dd><p>The new data to be transformed, either a matrix of data frame. Must
have the same columns in the same order as the input data used to generate
the <code>model</code>.</p></dd>


<dt>model</dt>
<dd><p>Data associated with an existing embedding.</p></dd>


<dt>nn_method</dt>
<dd><p>Optional pre-calculated nearest neighbor data. There are
two supported formats. The first is a list consisting of two elements:</p><ul><li><p><code>"idx"</code>. A <code>n_vertices x n_neighbors</code> matrix where
  <code>n_vertices</code> is the number of observations in <code>X</code>. The contents
  of the matrix should be the integer indexes of the data used to generate
  the <code>model</code>, which are the <code>n_neighbors</code>-nearest neighbors of
  the data to be transformed.</p></li>
<li><p><code>"dist"</code>. A <code>n_vertices x n_neighbors</code> matrix
  containing the distances of the nearest neighbors.</p></li>
</ul><p>The second supported format is a sparse distance matrix of type
<code>dgCMatrix</code>, with dimensions <code>n_model_vertices x n_vertices</code>.
where <code>n_model_vertices</code> is the number of observations in the original
data that generated the model. Distances should be arranged by column, i.e.
a non-zero entry in row <code>j</code> of the <code>i</code>th column indicates that
the <code>j</code>th observation in the original data used to generate the
<code>model</code> is a nearest neighbor of the <code>i</code>th observation in the new
data, with the distance given by the value of that element. In this format,
a different number of neighbors is allowed for each observation, i.e.
each column can contain a different number of non-zero values.
Multiple nearest neighbor data (e.g. from two different pre-calculated
metrics) can be passed by passing a list containing the nearest neighbor
data lists as items.</p></dd>


<dt>init_weighted</dt>
<dd><p>If <code>TRUE</code>, then initialize the embedded coordinates
of <code>X</code> using a weighted average of the coordinates of the nearest
neighbors from the original embedding in <code>model</code>, where the weights
used are the edge weights from the UMAP smoothed knn distances. Otherwise,
use an un-weighted average.
This parameter will be deprecated and removed at version 1.0 of this
package. Use the <code>init</code> parameter as a replacement, replacing
<code>init_weighted = TRUE</code> with <code>init = "weighted"</code> and
<code>init_weighted = FALSE</code> with <code>init = "average"</code>.</p></dd>


<dt>search_k</dt>
<dd><p>Number of nodes to search during the neighbor retrieval. The
larger k, the more the accurate results, but the longer the search takes.
Default is the value used in building the <code>model</code> is used.</p></dd>


<dt>tmpdir</dt>
<dd><p>Temporary directory to store nearest neighbor indexes during
nearest neighbor search. Default is <code><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></code>. The index is
only written to disk if <code>n_threads &gt; 1</code>; otherwise, this parameter is
ignored.</p></dd>


<dt>n_epochs</dt>
<dd><p>Number of epochs to use during the optimization of the
embedded coordinates. A value between <code>30 - 100</code> is a reasonable trade
off between speed and thoroughness. By default, this value is set to one
third the number of epochs used to build the <code>model</code>.</p></dd>


<dt>n_threads</dt>
<dd><p>Number of threads to use, (except during stochastic gradient
descent). Default is half the number of concurrent threads supported by the
system.</p></dd>


<dt>n_sgd_threads</dt>
<dd><p>Number of threads to use during stochastic gradient
descent. If set to &gt; 1, then be aware that if <code>batch = FALSE</code>, results
will <em>not</em> be reproducible, even if <code>set.seed</code> is called with a
fixed seed before running. Set to <code>"auto"</code> to use the same value as
<code>n_threads</code>.</p></dd>


<dt>grain_size</dt>
<dd><p>Minimum batch size for multithreading. If the number of
items to process in a thread falls below this number, then no threads will
be used. Used in conjunction with <code>n_threads</code> and
<code>n_sgd_threads</code>.</p></dd>


<dt>verbose</dt>
<dd><p>If <code>TRUE</code>, log details to the console.</p></dd>


<dt>init</dt>
<dd><p>how to initialize the transformed coordinates. One of:</p><ul><li><p><code>"weighted"</code> (The default). Use a weighted average of the
    coordinates of the nearest neighbors from the original embedding in
    <code>model</code>, where the weights used are the edge weights from the UMAP
    smoothed knn distances. Equivalent to <code>init_weighted = TRUE</code>.</p></li>
<li><p><code>"average"</code>. Use the mean average of the coordinates of
    the nearest neighbors from the original embedding in <code>model</code>.
    Equivalent to <code>init_weighted = FALSE</code>.</p></li>
<li><p>A matrix of user-specified input coordinates, which must have
    dimensions the same as <code>(nrow(X), ncol(model$embedding))</code>.</p></li>
</ul><p>This parameter should be used in preference to <code>init_weighted</code>.</p></dd>


<dt>batch</dt>
<dd><p>If <code>TRUE</code>, then embedding coordinates are updated at the
end of each epoch rather than during the epoch. In batch mode, results are
reproducible with a fixed random seed even with <code>n_sgd_threads &gt; 1</code>,
at the cost of a slightly higher memory use. You may also have to modify
<code>learning_rate</code> and increase <code>n_epochs</code>, so whether this provides
a speed increase over the single-threaded optimization is likely to be
dataset and hardware-dependent. If <code>NULL</code>, the transform will use the
value provided in the <code>model</code>, if available. Default: <code>FALSE</code>.</p></dd>


<dt>learning_rate</dt>
<dd><p>Initial learning rate used in optimization of the
coordinates. This overrides the value associated with the <code>model</code>.
This should be left unspecified under most circumstances.</p></dd>


<dt>opt_args</dt>
<dd><p>A list of optimizer parameters, used when
<code>batch = TRUE</code>. The default optimization method used is Adam (Kingma
and Ba, 2014).</p><ul><li><p><code>method</code> The optimization method to use. Either <code>"adam"</code>
  or <code>"sgd"</code> (stochastic gradient descent). Default: <code>"adam"</code>.</p></li>
<li><p><code>beta1</code> (Adam only). The weighting parameter for the
  exponential moving average of the first moment estimator. Effectively the
  momentum parameter. Should be a floating point value between 0 and 1.
  Higher values can smooth oscillatory updates in poorly-conditioned
  situations and may allow for a larger <code>learning_rate</code> to be
  specified, but too high can cause divergence. Default: <code>0.5</code>.</p></li>
<li><p><code>beta2</code> (Adam only). The weighting parameter for the
  exponential moving average of the uncentered second moment estimator.
  Should be a floating point value between 0 and 1. Controls the degree of
  adaptivity in the step-size. Higher values put more weight on previous
  time steps. Default: <code>0.9</code>.</p></li>
<li><p><code>eps</code> (Adam only). Intended to be a small value to prevent
  division by zero, but in practice can also affect convergence due to its
  interaction with <code>beta2</code>. Higher values reduce the effect of the
  step-size adaptivity and bring the behavior closer to stochastic gradient
  descent with momentum. Typical values are between 1e-8 and 1e-3. Default:
  <code>1e-7</code>.</p></li>
<li><p><code>alpha</code> The initial learning rate. Default: the value of the
  <code>learning_rate</code> parameter.</p></li>
</ul><p>If <code>NULL</code>, the transform will use the value provided in the
<code>model</code>, if available.</p></dd>


<dt>epoch_callback</dt>
<dd><p>A function which will be invoked at the end of every
epoch. Its signature should be:
<code>(epoch, n_epochs, coords, fixed_coords)</code>, where:</p><ul><li><p><code>epoch</code> The current epoch number (between <code>1</code> and
  <code>n_epochs</code>).</p></li>
<li><p><code>n_epochs</code> Number of epochs to use during the optimization of
  the embedded coordinates.</p></li>
<li><p><code>coords</code> The embedded coordinates as of the end of the current
  epoch, as a matrix with dimensions (N, <code>n_components</code>).</p></li>
<li><p><code>fixed_coords</code> The originally embedded coordinates from the
  <code>model</code>. These are fixed and do not change. A matrix with dimensions
  (Nmodel, <code>n_components</code>) where <code>Nmodel</code> is the number of
  observations in the original data.</p></li>
</ul></dd>


<dt>ret_extra</dt>
<dd><p>A vector indicating what extra data to return. May contain
any combination of the following strings:</p><ul><li><p><code>"fgraph"</code> the high dimensional fuzzy graph (i.e. the fuzzy
    simplicial set of the merged local views of the input data). The graph
    is returned as a sparse matrix of class <a href="https://rdrr.io/pkg/Matrix/man/dgCMatrix-class.html" class="external-link">dgCMatrix-class</a>
    with dimensions <code>NX</code> x <code>Nmodel</code>, where <code>NX</code> is the number
    of items in the data to transform in <code>X</code>, and <code>NModel</code> is
    the number of items in the data used to build the UMAP <code>model</code>.
    A non-zero entry (i, j) gives the membership strength of the edge
    connecting the vertex representing the ith item in <code>X</code> to the
    jth item in the data used to build the <code>model</code>. Note that the
    graph is further sparsified by removing edges with sufficiently low
    membership strength that they would not be sampled by the probabilistic
    edge sampling employed for optimization and therefore the number of
    non-zero elements in the matrix is dependent on <code>n_epochs</code>. If you
    are only interested in the fuzzy input graph (e.g. for clustering),
    setting <code>n_epochs = 0</code> will avoid any further sparsifying.</p></li>
</ul></dd>


<dt>seed</dt>
<dd><p>Integer seed to use to initialize the random number generator
state. Combined with <code>n_sgd_threads = 1</code> or <code>batch = TRUE</code>, this
should give consistent output across multiple runs on a given installation.
Setting this value is equivalent to calling <code><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></code>,
but it may be more convenient in some situations than having to call a
separate function. The default is to not set a seed, in which case this
function uses the behavior specified by the supplied <code>model</code>: If the
model specifies a seed, then the model seed will be used to seed then
random number generator, and results will still be consistent (if
<code>n_sgd_threads = 1</code>). If you want to force the seed to not be set,
even if it is set in <code>model</code>, set <code>seed = FALSE</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A matrix of coordinates for <code>X</code> transformed into the space
  of the <code>model</code>, or if <code>ret_extra</code> is specified, a list
  containing:</p>
<p></p>
<ul><li><p><code>embedding</code> the matrix of optimized coordinates.</p></li>
<li><p>if <code>ret_extra</code> contains <code>"fgraph"</code>, an item of the same
    name containing the high-dimensional fuzzy graph as a sparse matrix, of
    type <a href="https://rdrr.io/pkg/Matrix/man/dgCMatrix-class.html" class="external-link">dgCMatrix-class</a>.</p></li>
<li><p>if <code>ret_extra</code> contains <code>"sigma"</code>, returns a vector of
    the smooth knn distance normalization terms for each observation as
    <code>"sigma"</code> and a vector <code>"rho"</code> containing the largest
    distance to the locally connected neighbors of each observation.</p></li>
<li><p>if <code>ret_extra</code> contains <code>"localr"</code>, an item of the same
    name containing a vector of the estimated local radii, the sum of
    <code>"sigma"</code> and <code>"rho"</code>.</p></li>
<li><p>if <code>ret_extra</code> contains <code>"nn"</code>, an item of the same name
    containing the nearest neighbors of each item in <code>X</code> (with respect
    to the items that created the <code>model</code>).</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Note that some settings are incompatible with the production of a UMAP model
via <code><a href="umap.html">umap</a></code>: external neighbor data (passed via a list to the
argument of the <code>nn_method</code> parameter), and factor columns that were
included in the UMAP calculation via the <code>metric</code> parameter. In the
latter case, the model produced is based only on the numeric data.
A transformation is possible, but factor columns in the new data are ignored.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">iris_train</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">iris_test</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="fl">101</span><span class="op">:</span><span class="fl">150</span>, <span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># You must set ret_model = TRUE to return extra data needed</span></span></span>
<span class="r-in"><span><span class="va">iris_train_umap</span> <span class="op">&lt;-</span> <span class="fu"><a href="umap.html">umap</a></span><span class="op">(</span><span class="va">iris_train</span>, ret_model <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">iris_test_umap</span> <span class="op">&lt;-</span> <span class="fu">umap_transform</span><span class="op">(</span><span class="va">iris_test</span>, <span class="va">iris_train_umap</span><span class="op">)</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by James Melville.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.</p>
</div>

    </footer></div>

  

  

  </body></html>

